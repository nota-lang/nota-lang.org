<!DOCTYPE html><html lang="en" class=""><head><style>.ͼ1.cm-editor.cm-focused {outline: 1px dotted #212121;}
.ͼ1.cm-editor {position: relative !important; box-sizing: border-box; display: flex !important; flex-direction: column;}
.ͼ1 .cm-scroller {display: flex !important; align-items: flex-start !important; font-family: monospace; line-height: 1.4; height: 100%; overflow-x: auto; position: relative; z-index: 0;}
.ͼ1 .cm-content[contenteditable=true] {-webkit-user-modify: read-write-plaintext-only;}
.ͼ1 .cm-content {margin: 0; flex-grow: 2; flex-shrink: 0; min-height: 100%; display: block; white-space: pre; word-wrap: normal; box-sizing: border-box; padding: 4px 0; outline: none;}
.ͼ1 .cm-lineWrapping {white-space: pre-wrap; white-space: break-spaces; word-break: break-word; overflow-wrap: anywhere; flex-shrink: 1;}
.ͼ2 .cm-content {caret-color: black;}
.ͼ3 .cm-content {caret-color: white;}
.ͼ1 .cm-line {display: block; padding: 0 2px 0 4px;}
.ͼ1 .cm-selectionLayer {z-index: -1; contain: size style;}
.ͼ1 .cm-selectionBackground {position: absolute;}
.ͼ2 .cm-selectionBackground {background: #d9d9d9;}
.ͼ3 .cm-selectionBackground {background: #222;}
.ͼ2.cm-focused .cm-selectionBackground {background: #d7d4f0;}
.ͼ3.cm-focused .cm-selectionBackground {background: #233;}
.ͼ1 .cm-cursorLayer {z-index: 100; contain: size style; pointer-events: none;}
.ͼ1.cm-focused .cm-cursorLayer {animation: steps(1) cm-blink 1.2s infinite;}
@keyframes cm-blink {50% {opacity: 0;}}
@keyframes cm-blink2 {50% {opacity: 0;}}
.ͼ1 .cm-cursor, .ͼ1 .cm-dropCursor {position: absolute; border-left: 1.2px solid black; margin-left: -0.6px; pointer-events: none;}
.ͼ1 .cm-cursor {display: none;}
.ͼ3 .cm-cursor {border-left-color: #444;}
.ͼ1.cm-focused .cm-cursor {display: block;}
.ͼ2 .cm-activeLine {background-color: #f3f9ff;}
.ͼ3 .cm-activeLine {background-color: #223039;}
.ͼ2 .cm-specialChar {color: red;}
.ͼ3 .cm-specialChar {color: #f78;}
.ͼ1 .cm-gutters {flex-shrink: 0; display: flex; height: 100%; box-sizing: border-box; left: 0; z-index: 200;}
.ͼ2 .cm-gutters {background-color: #f5f5f5; color: #6c6c6c; border-right: 1px solid #ddd;}
.ͼ3 .cm-gutters {background-color: #333338; color: #ccc;}
.ͼ1 .cm-gutter {display: flex !important; flex-direction: column; flex-shrink: 0; box-sizing: border-box; min-height: 100%; overflow: hidden;}
.ͼ1 .cm-gutterElement {box-sizing: border-box;}
.ͼ1 .cm-lineNumbers .cm-gutterElement {padding: 0 3px 0 5px; min-width: 20px; text-align: right; white-space: nowrap;}
.ͼ2 .cm-activeLineGutter {background-color: #e2f2ff;}
.ͼ3 .cm-activeLineGutter {background-color: #222227;}
.ͼ1 .cm-panels {box-sizing: border-box; position: sticky; left: 0; right: 0;}
.ͼ2 .cm-panels {background-color: #f5f5f5; color: black;}
.ͼ2 .cm-panels-top {border-bottom: 1px solid #ddd;}
.ͼ2 .cm-panels-bottom {border-top: 1px solid #ddd;}
.ͼ3 .cm-panels {background-color: #333338; color: white;}
.ͼ1 .cm-tab {display: inline-block; overflow: hidden; vertical-align: bottom;}
.ͼ1 .cm-widgetBuffer {vertical-align: text-top; height: 1em; width: 0; display: inline;}
.ͼ1 .cm-placeholder {color: #888; display: inline-block; vertical-align: top;}
.ͼ1 .cm-button {vertical-align: middle; color: inherit; font-size: 70%; padding: .2em 1em; border-radius: 1px;}
.ͼ2 .cm-button:active {background-image: linear-gradient(#b4b4b4, #d0d3d6);}
.ͼ2 .cm-button {background-image: linear-gradient(#eff1f5, #d9d9df); border: 1px solid #888;}
.ͼ3 .cm-button:active {background-image: linear-gradient(#111, #333);}
.ͼ3 .cm-button {background-image: linear-gradient(#393939, #111); border: 1px solid #888;}
.ͼ1 .cm-textfield {vertical-align: middle; color: inherit; font-size: 70%; border: 1px solid silver; padding: .2em .5em;}
.ͼ2 .cm-textfield {background-color: white;}
.ͼ3 .cm-textfield {border: 1px solid #555; background-color: inherit;}
.ͼo .cm-scroller {font-family: var(--font-mono);}
.ͼo .cm-gutters {background: var(--bg); border: none;}
.ͼo .cm-lineNumbers .cm-gutterElement {font-size: 12px; padding-top: 2px; padding-right: 7px; min-width: 10px;}
.ͼo .cm-highlight {padding: 0 2px; margin: -1px -2px; border-radius: 2px;}
.ͼ5 {color: #7a757a;}
.ͼ6 {text-decoration: underline;}
.ͼ7 {text-decoration: underline; font-weight: bold;}
.ͼ8 {font-style: italic;}
.ͼ9 {font-weight: bold;}
.ͼa {text-decoration: line-through;}
.ͼb {color: #708;}
.ͼc {color: #219;}
.ͼd {color: #164;}
.ͼe {color: #a11;}
.ͼf {color: #e40;}
.ͼg {color: #00f;}
.ͼh {color: #30a;}
.ͼi {color: #085;}
.ͼj {color: #167;}
.ͼk {color: #256;}
.ͼl {color: #00c;}
.ͼm {color: #940;}
.ͼn {color: #f00;}
</style><link href="index.css" rel="stylesheet"><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Type-Level Programming in Rust</title></head><body><div id="root"><div class="nota-document"><div class="document-title">Type-Level Programming in Rust</div><div class="authors"><div class="author"><span class="author-name">Will Crichton</span></div></div><div class="abstract">I show how two domain-specific type systems, information flow control and two-party communication protocols, can be implemented in Rust using type-level programming. I explain how interesting properties of these domains can be verified at compile-time. Finally, I construct a general correspondence between type operators, logic programs, and their encoding in Rust.</div><p>Typestate is the concept of encoding state machines in a programming language’s type system. While not specific to Rust, typestate has been <a href="https://stanford-cs242.github.io/f19/lectures/08-2-typestate">explored</a> <a href="https://yoric.github.io/post/rust-typestate/">elsewhere</a> <a href="https://blog.systems.ethz.ch/blog/2018/a-hammer-you-can-only-hold-by-the-handle.html">at length</a> in the context of Rust. Typestate boils down to four ideas:</p><ol><li><p>Each state is represented as a unique type.</p></li><li><p>State transitions are only available as methods for the corresponding state type.</p></li><li><p>Taking a state transition returns a state machine of the new state type.</p></li><li><p>State transitions invalidate old state.</p></li></ol><p>For example, here’s a state machine for a send-then-receive channel:</p><div class="listing"><div class="cm-editor ͼ1 ͼ2 ͼo"><div aria-live="polite" style="position: absolute; top: -10000px;"></div><div tabindex="-1" class="cm-scroller"><div class="cm-gutters" aria-hidden="true" style="min-height: 914.75px; position: sticky;"><div class="cm-gutter cm-lineNumbers"><div class="cm-gutterElement" style="height: 0px; visibility: hidden; pointer-events: none;">99</div><div class="cm-gutterElement" style="height: 25.1875px; margin-top: 4px;">1</div><div class="cm-gutterElement" style="height: 25.1875px;">2</div><div class="cm-gutterElement" style="height: 25.1875px;">3</div><div class="cm-gutterElement" style="height: 25.1875px;">4</div><div class="cm-gutterElement" style="height: 25.1875px;">5</div><div class="cm-gutterElement" style="height: 25.1875px;">6</div><div class="cm-gutterElement" style="height: 25.1875px;">7</div><div class="cm-gutterElement" style="height: 25.1875px;">8</div><div class="cm-gutterElement" style="height: 25.1875px;">9</div><div class="cm-gutterElement" style="height: 25.1875px;">10</div><div class="cm-gutterElement" style="height: 25.1875px;">11</div><div class="cm-gutterElement" style="height: 25.1875px;">12</div><div class="cm-gutterElement" style="height: 25.1875px;">13</div><div class="cm-gutterElement" style="height: 25.1875px;">14</div><div class="cm-gutterElement" style="height: 25.1875px;">15</div><div class="cm-gutterElement" style="height: 25.1875px;">16</div><div class="cm-gutterElement" style="height: 25.1875px;">17</div><div class="cm-gutterElement" style="height: 25.1875px;">18</div><div class="cm-gutterElement" style="height: 25.1875px;">19</div><div class="cm-gutterElement" style="height: 25.1875px;">20</div><div class="cm-gutterElement" style="height: 25.1875px;">21</div><div class="cm-gutterElement" style="height: 25.1875px;">22</div><div class="cm-gutterElement" style="height: 25.1875px;">23</div><div class="cm-gutterElement" style="height: 25.1875px;">24</div><div class="cm-gutterElement" style="height: 25.1875px;">25</div><div class="cm-gutterElement" style="height: 25.1875px;">26</div><div class="cm-gutterElement" style="height: 25.1875px;">27</div><div class="cm-gutterElement" style="height: 25.1875px;">28</div><div class="cm-gutterElement" style="height: 25.1875px;">29</div><div class="cm-gutterElement" style="height: 25.1875px;">30</div><div class="cm-gutterElement" style="height: 25.1875px;">31</div><div class="cm-gutterElement" style="height: 25.1875px;">32</div><div class="cm-gutterElement" style="height: 25.1875px;">33</div><div class="cm-gutterElement" style="height: 25.1875px;">34</div><div class="cm-gutterElement" style="height: 25.1875px;">35</div><div class="cm-gutterElement" style="height: 25.1875px;">36</div></div></div><div spellcheck="false" autocorrect="off" autocapitalize="off" translate="no" contenteditable="false" class="cm-content" style="tab-size: 4;" role="textbox" aria-multiline="true"><div class="cm-line"><span class="ͼm">// Each state is a unique type</span></div><div class="cm-line"><span class="ͼb">struct</span> <span class="ͼi">Receiving</span>;</div><div class="cm-line"><span class="ͼb">struct</span> <span class="ͼi">Sending</span>;</div><div class="cm-line"><br></div><div class="cm-line"><span class="ͼm">// The state machine is parameterized by the state</span></div><div class="cm-line"><span class="ͼ5">#[repr(transparent)]</span></div><div class="cm-line"><span class="ͼb">struct</span> <span class="ͼi">Channel</span>&lt;<span class="ͼi">State</span>&gt; {</div><div class="cm-line">  chan: ...,</div><div class="cm-line">  _state: <span class="ͼi">PhantomData</span>&lt;<span class="ͼi">State</span>&gt;</div><div class="cm-line">}</div><div class="cm-line"><br></div><div class="cm-line"><br></div><div class="cm-line"><span class="ͼm">// Methods for the state are uniquely associated with only the state</span></div><div class="cm-line"><span class="ͼb">impl</span> <span class="ͼi">Channel</span>&lt;<span class="ͼi">Receiving</span>&gt; {</div><div class="cm-line">  <span class="ͼm">// recv consumes ownership, ensuring old state is invalidated</span></div><div class="cm-line">  <span class="ͼb">fn</span> <span class="ͼg">recv</span>(<span class="ͼb">mut</span> <span class="ͼb">self</span>) -&gt; (<span class="ͼi">Channel</span>&lt;<span class="ͼi">Sending</span>&gt;, <span class="ͼi">String</span>) {</div><div class="cm-line">    <span class="ͼb">let</span> <span class="ͼg">msg</span> = <span class="ͼb">self</span>.chan.recv();</div><div class="cm-line">    <span class="ͼm">// The state type changes after executing a transition</span></div><div class="cm-line">    (<span class="ͼb">unsafe</span> { transmute(<span class="ͼb">self</span>) }, msg)</div><div class="cm-line">  }</div><div class="cm-line">}</div><div class="cm-line"><br></div><div class="cm-line"><span class="ͼb">impl</span> <span class="ͼi">Channel</span>&lt;<span class="ͼi">Sending</span>&gt; {</div><div class="cm-line">  <span class="ͼb">fn</span> <span class="ͼg">send</span>(<span class="ͼb">mut</span> <span class="ͼb">self</span>, <span class="ͼg">msg</span>: <span class="ͼi">String</span>) -&gt; <span class="ͼi">Channel</span>&lt;<span class="ͼi">Receiving</span>&gt; {</div><div class="cm-line">    <span class="ͼb">self</span>.chan.send(msg);</div><div class="cm-line">    <span class="ͼb">unsafe</span> { transmute(<span class="ͼb">self</span>) }</div><div class="cm-line">  }</div><div class="cm-line">}</div><div class="cm-line"><br></div><div class="cm-line"><span class="ͼ5">#[test]</span></div><div class="cm-line"><span class="ͼb">fn</span> <span class="ͼg">channel_test</span>() {</div><div class="cm-line">  <span class="ͼb">let</span> <span class="ͼg">c</span>: <span class="ͼi">Channel</span>&lt;<span class="ͼi">Sending</span>&gt; = <span class="ͼi">Channel</span>::new();</div><div class="cm-line">  <span class="ͼb">let</span> <span class="ͼg">c</span>: <span class="ͼi">Channel</span>&lt;<span class="ͼi">Receiving</span>&gt; = c.send(<span class="ͼe">"hi"</span>);</div><div class="cm-line">  <span class="ͼb">let</span> (<span class="ͼg">c</span>, <span class="ͼg">msg</span>) = c.recv();</div><div class="cm-line">  <span class="ͼm">// and so on</span></div><div class="cm-line">}</div></div></div></div></div><div class="aside block">There are <a href="https://news.ycombinator.com/item?id=24688233">many</a> <a href="https://www.reddit.com/r/rust/comments/gaxlm3/typelevel_programming_in_rust/fp2gjhg/">readers</a> concerned with the use of <code>transmute</code>. The use of <code>#[repr(transparent)]</code> ensures that the layout of <code>Channel</code> is <a href="https://doc.rust-lang.org/nomicon/other-reprs.html#reprtransparent">stable across transmutations</a> of the marker type.</div><p>This pattern works effectively for simple finite state machines, where the logic to determine the next state is straightforward. In this note, I will explore situations where determining the next state is not so simple. In the process, we’ll talk about <strong>type-level programming</strong>, or how you can use Rust’s type system to encode <strong>computations on types</strong>.</p><div class="aside block">Part of the goal of this note is to show the value of type-level programming in practice. These same mechanisms have already been used for more esoteric purposes like <a href="https://sdleffler.github.io/RustTypeSystemTuringComplete/">showing Rust’s type system is Turing complete</a>, but I think type-level programming can really help us design better systems!</div><section><h1 class="section-title"><div id="def-section-1" class="definition"><span class="section-number">1</span>  Information Flow Control</div></h1><p>As a first example, consider a basic information flow control problem. In our program we have low security values (anyone can read them) and high security values (only authorized users can read them). We represent this idea like so:</p><div class="listing"><div class="cm-editor ͼ1 ͼ2 ͼo"><div aria-live="polite" style="position: absolute; top: -10000px;"></div><div tabindex="-1" class="cm-scroller"><div class="cm-gutters" aria-hidden="true" style="min-height: 406px; position: sticky;"><div class="cm-gutter cm-lineNumbers"><div class="cm-gutterElement" style="height: 0px; visibility: hidden; pointer-events: none;">99</div><div class="cm-gutterElement" style="height: 14px;">1</div><div class="cm-gutterElement" style="height: 14px;">2</div><div class="cm-gutterElement" style="height: 14px;">3</div><div class="cm-gutterElement" style="height: 14px;">4</div><div class="cm-gutterElement" style="height: 14px;">5</div><div class="cm-gutterElement" style="height: 14px;">6</div><div class="cm-gutterElement" style="height: 14px;">7</div><div class="cm-gutterElement" style="height: 14px;">8</div><div class="cm-gutterElement" style="height: 14px;">9</div><div class="cm-gutterElement" style="height: 14px;">10</div><div class="cm-gutterElement" style="height: 14px;">11</div><div class="cm-gutterElement" style="height: 14px;">12</div><div class="cm-gutterElement" style="height: 14px;">13</div><div class="cm-gutterElement" style="height: 14px;">14</div><div class="cm-gutterElement" style="height: 14px;">15</div><div class="cm-gutterElement" style="height: 14px;">16</div><div class="cm-gutterElement" style="height: 14px;">17</div><div class="cm-gutterElement" style="height: 14px;">18</div><div class="cm-gutterElement" style="height: 14px;">19</div><div class="cm-gutterElement" style="height: 14px;">20</div><div class="cm-gutterElement" style="height: 14px;">21</div><div class="cm-gutterElement" style="height: 14px;">22</div><div class="cm-gutterElement" style="height: 14px;">23</div><div class="cm-gutterElement" style="height: 14px;">24</div><div class="cm-gutterElement" style="height: 14px;">25</div><div class="cm-gutterElement" style="height: 14px;">26</div><div class="cm-gutterElement" style="height: 14px;">27</div><div class="cm-gutterElement" style="height: 14px;">28</div><div class="cm-gutterElement" style="height: 14px;">29</div></div></div><div spellcheck="false" autocorrect="off" autocapitalize="off" translate="no" contenteditable="false" class="cm-content" style="tab-size: 4" role="textbox" aria-multiline="true"><div class="cm-line"><span class="ͼm">// Each security level is a type</span></div><div class="cm-line"><span class="ͼb">struct</span> <span class="ͼi">HighSec</span>;</div><div class="cm-line"><span class="ͼb">struct</span> <span class="ͼi">LowSec</span>;</div><div class="cm-line"><br></div><div class="cm-line"><span class="ͼm">// An Item wraps an arbitrary type T, associating it with a Level</span></div><div class="cm-line"><span class="ͼ5">#[repr(transparent)]</span></div><div class="cm-line"><span class="ͼb">struct</span> <span class="ͼi">Item</span>&lt;<span class="ͼi">T</span>, <span class="ͼi">Level</span>&gt; {</div><div class="cm-line">  t: <span class="ͼi">Box</span>&lt;<span class="ͼi">T</span>&gt;,</div><div class="cm-line">  _marker: <span class="ͼi">PhantomData</span>&lt;<span class="ͼi">Level</span>&gt;</div><div class="cm-line">}</div><div class="cm-line"><br></div><div class="cm-line"><span class="ͼm">// Constructors for building items of a particular security</span></div><div class="cm-line"><span class="ͼb">impl</span>&lt;<span class="ͼi">T</span>&gt; <span class="ͼi">Item</span>&lt;<span class="ͼi">T</span>, <span class="ͼi">LowSec</span>&gt; {</div><div class="cm-line">  <span class="ͼb">pub</span> <span class="ͼb">fn</span> <span class="ͼg">low_sec</span>(<span class="ͼg">t</span>: <span class="ͼi">T</span>) -&gt; <span class="ͼi">Item</span>&lt;<span class="ͼi">T</span>, <span class="ͼi">LowSec</span>&gt; {</div><div class="cm-line">    <span class="ͼi">Item</span> { t: <span class="ͼi">Box</span>::new(t), _marker: PhantomData }</div><div class="cm-line">  }</div><div class="cm-line"><br></div><div class="cm-line">  <span class="ͼb">pub</span> <span class="ͼb">fn</span> <span class="ͼg">high_sec</span>(<span class="ͼg">t</span>: <span class="ͼi">T</span>) -&gt; <span class="ͼi">Item</span>&lt;<span class="ͼi">T</span>, <span class="ͼi">HighSec</span>&gt; {</div><div class="cm-line">    <span class="ͼi">Item</span> { t: <span class="ͼi">Box</span>::new(t), _marker: PhantomData }</div><div class="cm-line">  }</div><div class="cm-line">}</div><div class="cm-line"><br></div><div class="cm-line"><span class="ͼm">// For simplicity, a naked Item can be read by anyone</span></div><div class="cm-line"><span class="ͼb">impl</span>&lt;<span class="ͼi">T</span>, <span class="ͼi">Level</span>&gt; <span class="ͼi">Deref</span> <span class="ͼb">for</span> <span class="ͼi">Item</span>&lt;<span class="ͼi">T</span>, <span class="ͼi">Level</span>&gt; {</div><div class="cm-line">  <span class="ͼb">type</span> <span class="ͼi">Target</span> = <span class="ͼi">T</span>;</div><div class="cm-line">  <span class="ͼb">fn</span> <span class="ͼg">deref</span>(&amp;<span class="ͼb">self</span>) -&gt; &amp;<span class="ͼi">T</span> {</div><div class="cm-line">    &amp;<span class="ͼb">self</span>.t</div><div class="cm-line">  }</div><div class="cm-line">}</div></div></div></div></div><p>We would like to have a vector of these items with the following property:</p><ul><li><p>If all of the items are low security, anyone can read any item.</p></li><li><p>If any of the items are high security, only an authorized user can read any item.</p></li></ul><p>For example, our vector should pass this test:</p><div class="listing"><div class="cm-editor ͼ1 ͼ2 ͼo"><div aria-live="polite" style="position: absolute; top: -10000px;"></div><div tabindex="-1" class="cm-scroller"><div class="cm-gutters" aria-hidden="true" style="min-height: 154px; position: sticky;"><div class="cm-gutter cm-lineNumbers"><div class="cm-gutterElement" style="height: 0px; visibility: hidden; pointer-events: none;">99</div><div class="cm-gutterElement" style="height: 14px;">1</div><div class="cm-gutterElement" style="height: 14px;">2</div><div class="cm-gutterElement" style="height: 14px;">3</div><div class="cm-gutterElement" style="height: 14px;">4</div><div class="cm-gutterElement" style="height: 14px;">5</div><div class="cm-gutterElement" style="height: 14px;">6</div><div class="cm-gutterElement" style="height: 14px;">7</div><div class="cm-gutterElement" style="height: 14px;">8</div><div class="cm-gutterElement" style="height: 14px;">9</div><div class="cm-gutterElement" style="height: 14px;">10</div><div class="cm-gutterElement" style="height: 14px;">11</div></div></div><div spellcheck="false" autocorrect="off" autocapitalize="off" translate="no" contenteditable="false" class="cm-content" style="tab-size: 4" role="textbox" aria-multiline="true"><div class="cm-line"><span class="ͼb">let</span> <span class="ͼg">v</span> = <span class="ͼi">SecureVec</span>::new();</div><div class="cm-line"><span class="ͼb">let</span> <span class="ͼg">lo</span> = <span class="ͼi">Item</span>::low_sec(<span class="ͼd">1</span>);</div><div class="cm-line"><span class="ͼb">let</span> <span class="ͼg">hi</span> = <span class="ͼi">Item</span>::high_sec(<span class="ͼd">2</span>);</div><div class="cm-line"><span class="ͼb">let</span> <span class="ͼg">v</span> = v.push(lo);         <span class="ͼm">// v is still low sec</span></div><div class="cm-line"><span class="ͼk">assert_eq</span><span class="ͼk">!</span>(*v.get(<span class="ͼd">0</span>), <span class="ͼd">1</span>);   <span class="ͼm">// ok to read v</span></div><div class="cm-line"><br></div><div class="cm-line"><span class="ͼb">let</span> <span class="ͼg">v</span> = v.push(hi);         <span class="ͼm">// v is now high sec</span></div><div class="cm-line"><span class="ͼm">// assert_eq!(v.get(0), 1); // can't read any more, compiler error</span></div><div class="cm-line"><br></div><div class="cm-line"><span class="ͼb">let</span> <span class="ͼg">w</span> = <span class="ͼi">HighSecWitness</span>::login();</div><div class="cm-line"><span class="ͼk">assert_eq</span><span class="ͼk">!</span>(*v.get_secure(<span class="ͼd">1</span>, w), <span class="ͼd">2</span>); <span class="ͼm">// can read after login</span></div></div></div></div></div><p>A basic type-state attempt looks like this. We can create and read a low-security vector:</p><div class="listing"><div class="cm-editor ͼ1 ͼ2 ͼo"><div aria-live="polite" style="position: absolute; top: -10000px;"></div><div tabindex="-1" class="cm-scroller"><div class="cm-gutters" aria-hidden="true" style="min-height: 210px; position: sticky;"><div class="cm-gutter cm-lineNumbers"><div class="cm-gutterElement" style="height: 0px; visibility: hidden; pointer-events: none;">99</div><div class="cm-gutterElement" style="height: 14px;">1</div><div class="cm-gutterElement" style="height: 14px;">2</div><div class="cm-gutterElement" style="height: 14px;">3</div><div class="cm-gutterElement" style="height: 14px;">4</div><div class="cm-gutterElement" style="height: 14px;">5</div><div class="cm-gutterElement" style="height: 14px;">6</div><div class="cm-gutterElement" style="height: 14px;">7</div><div class="cm-gutterElement" style="height: 14px;">8</div><div class="cm-gutterElement" style="height: 14px;">9</div><div class="cm-gutterElement" style="height: 14px;">10</div><div class="cm-gutterElement" style="height: 14px;">11</div><div class="cm-gutterElement" style="height: 14px;">12</div><div class="cm-gutterElement" style="height: 14px;">13</div><div class="cm-gutterElement" style="height: 14px;">14</div><div class="cm-gutterElement" style="height: 14px;">15</div></div></div><div spellcheck="false" autocorrect="off" autocapitalize="off" translate="no" contenteditable="false" class="cm-content" style="tab-size: 4" role="textbox" aria-multiline="true"><div class="cm-line"><span class="ͼ5">#[repr(transparent)]</span></div><div class="cm-line"><span class="ͼb">struct</span> <span class="ͼi">SecureVec</span>&lt;<span class="ͼi">T</span>, <span class="ͼi">Level</span>&gt; {</div><div class="cm-line">  items: <span class="ͼi">Vec</span>&lt;<span class="ͼi">Item</span>&lt;<span class="ͼi">T</span>, <span class="ͼi">Level</span>&gt;&gt;,</div><div class="cm-line">  _marker: <span class="ͼi">PhantomData</span>&lt;<span class="ͼi">Level</span>&gt;</div><div class="cm-line">}</div><div class="cm-line"><br></div><div class="cm-line"><span class="ͼb">impl</span>&lt;<span class="ͼi">T</span>&gt; <span class="ͼi">SecureVec</span>&lt;<span class="ͼi">T</span>, <span class="ͼi">LowSec</span>&gt; {</div><div class="cm-line">  <span class="ͼb">pub</span> <span class="ͼb">fn</span> <span class="ͼg">new</span>() -&gt; <span class="ͼi">SecureVec</span>&lt;<span class="ͼi">T</span>, <span class="ͼi">LowSec</span>&gt; {</div><div class="cm-line">    <span class="ͼi">SecureVec</span> { items: <span class="ͼi">Vec</span>::new(), _marker: PhantomData }</div><div class="cm-line">  }</div><div class="cm-line"><br></div><div class="cm-line">  <span class="ͼb">pub</span> <span class="ͼb">fn</span> <span class="ͼg">get</span>(&amp;<span class="ͼb">self</span>, <span class="ͼg">i</span>: <span class="ͼi">usize</span>) -&gt; &amp;<span class="ͼi">T</span> {</div><div class="cm-line">    &amp;<span class="ͼb">self</span>.items[i]</div><div class="cm-line">  }</div><div class="cm-line">}</div></div></div></div></div><p>And we can protect a high-security vector through a witness:</p><div class="listing"><div class="cm-editor ͼ1 ͼ2 ͼo"><div aria-live="polite" style="position: absolute; top: -10000px;"></div><div tabindex="-1" class="cm-scroller"><div class="cm-gutters" aria-hidden="true" style="min-height: 168px; position: sticky;"><div class="cm-gutter cm-lineNumbers"><div class="cm-gutterElement" style="height: 0px; visibility: hidden; pointer-events: none;">99</div><div class="cm-gutterElement" style="height: 14px;">1</div><div class="cm-gutterElement" style="height: 14px;">2</div><div class="cm-gutterElement" style="height: 14px;">3</div><div class="cm-gutterElement" style="height: 14px;">4</div><div class="cm-gutterElement" style="height: 14px;">5</div><div class="cm-gutterElement" style="height: 14px;">6</div><div class="cm-gutterElement" style="height: 14px;">7</div><div class="cm-gutterElement" style="height: 14px;">8</div><div class="cm-gutterElement" style="height: 14px;">9</div><div class="cm-gutterElement" style="height: 14px;">10</div><div class="cm-gutterElement" style="height: 14px;">11</div><div class="cm-gutterElement" style="height: 14px;">12</div></div></div><div spellcheck="false" autocorrect="off" autocapitalize="off" translate="no" contenteditable="false" class="cm-content" style="tab-size: 4" role="textbox" aria-multiline="true"><div class="cm-line"><span class="ͼb">struct</span> <span class="ͼi">HighSecWitness</span>;</div><div class="cm-line"><span class="ͼb">impl</span> <span class="ͼi">HighSecWitness</span> {</div><div class="cm-line">  <span class="ͼm">// sprinkle some high-security authentication in here...</span></div><div class="cm-line">  <span class="ͼb">pub</span> <span class="ͼb">fn</span> <span class="ͼg">login</span>() -&gt; <span class="ͼi">HighSecWitness</span> { HighSecWitness }</div><div class="cm-line">}</div><div class="cm-line"><br></div><div class="cm-line"><br></div><div class="cm-line"><span class="ͼb">impl</span>&lt;<span class="ͼi">T</span>&gt; <span class="ͼi">SecureVec</span>&lt;<span class="ͼi">T</span>, <span class="ͼi">HighSec</span>&gt; {</div><div class="cm-line">  <span class="ͼb">pub</span> <span class="ͼb">fn</span> <span class="ͼg">get_secure</span>(&amp;<span class="ͼb">self</span>, <span class="ͼg">i</span>: <span class="ͼi">usize</span>, <span class="ͼg">_witness</span>: <span class="ͼi">HighSecWitness</span>) -&gt; &amp;<span class="ͼi">T</span> {</div><div class="cm-line">    &amp;<span class="ͼb">self</span>.items[i]</div><div class="cm-line">  }</div><div class="cm-line">}</div></div></div></div></div><p>Now, to the main idea: how can we implement <code>push</code>? There are four possible state combinations: a high/low security vector with a high/low security item. While we can implement each combination as a separate method, it’s simpler to consider the underlying logic. <code>push</code> should return a vector of level <code>max(vec_level, item_level)</code> where <code>max(hi, lo) = hi</code>.</p><p>Our goal is to encode <code>max</code> as a <em>type-level computation</em>, i.e. an operator on types. The high-level idea:</p><ul><li><p>Traits definitions are function signatures from types to types.</p></li><li><p>Trait type parameters represent inputs and associated types represent outputs.</p></li><li><p>Trait implementations define individual mappings from inputs to outputs.</p></li></ul><p>Here are those ideas in action to compute the max security level:</p><div class="listing"><div class="cm-editor ͼ1 ͼ2 ͼo"><div aria-live="polite" style="position: absolute; top: -10000px;"></div><div tabindex="-1" class="cm-scroller"><div class="cm-gutters" aria-hidden="true" style="min-height: 196px; position: sticky;"><div class="cm-gutter cm-lineNumbers"><div class="cm-gutterElement" style="height: 0px; visibility: hidden; pointer-events: none;">99</div><div class="cm-gutterElement" style="height: 14px;">1</div><div class="cm-gutterElement" style="height: 14px;">2</div><div class="cm-gutterElement" style="height: 14px;">3</div><div class="cm-gutterElement" style="height: 14px;">4</div><div class="cm-gutterElement" style="height: 14px;">5</div><div class="cm-gutterElement" style="height: 14px;">6</div><div class="cm-gutterElement" style="height: 14px;">7</div><div class="cm-gutterElement" style="height: 14px;">8</div><div class="cm-gutterElement" style="height: 14px;">9</div><div class="cm-gutterElement" style="height: 14px;">10</div><div class="cm-gutterElement" style="height: 14px;">11</div><div class="cm-gutterElement" style="height: 14px;">12</div><div class="cm-gutterElement" style="height: 14px;">13</div><div class="cm-gutterElement" style="height: 14px;">14</div></div></div><div spellcheck="false" autocorrect="off" autocapitalize="off" translate="no" contenteditable="false" class="cm-content" style="tab-size: 4" role="textbox" aria-multiline="true"><div class="cm-line"><span class="ͼm">// Self (implicitly) is the left operand, Other is the right operand,</span></div><div class="cm-line"><span class="ͼm">// and Output is the output</span></div><div class="cm-line"><span class="ͼb">trait</span> <span class="ͼi">ComputeMaxLevel</span>&lt;<span class="ͼi">Other</span>&gt; {</div><div class="cm-line">  <span class="ͼb">type</span> <span class="ͼi">Output</span>;</div><div class="cm-line">}</div><div class="cm-line"><br></div><div class="cm-line"><span class="ͼm">// These impls define the core computation</span></div><div class="cm-line"><span class="ͼb">impl</span> <span class="ͼi">ComputeMaxLevel</span>&lt;<span class="ͼi">LowSec</span>&gt;  <span class="ͼb">for</span> <span class="ͼi">LowSec</span>  { <span class="ͼb">type</span> <span class="ͼi">Output</span> = <span class="ͼi">LowSec</span>;  }</div><div class="cm-line"><span class="ͼb">impl</span> <span class="ͼi">ComputeMaxLevel</span>&lt;<span class="ͼi">HighSec</span>&gt; <span class="ͼb">for</span> <span class="ͼi">LowSec</span>  { <span class="ͼb">type</span> <span class="ͼi">Output</span> = <span class="ͼi">HighSec</span>; }</div><div class="cm-line"><span class="ͼb">impl</span> <span class="ͼi">ComputeMaxLevel</span>&lt;<span class="ͼi">LowSec</span>&gt;  <span class="ͼb">for</span> <span class="ͼi">HighSec</span> { <span class="ͼb">type</span> <span class="ͼi">Output</span> = <span class="ͼi">HighSec</span>; }</div><div class="cm-line"><span class="ͼb">impl</span> <span class="ͼi">ComputeMaxLevel</span>&lt;<span class="ͼi">HighSec</span>&gt; <span class="ͼb">for</span> <span class="ͼi">HighSec</span> { <span class="ͼb">type</span> <span class="ͼi">Output</span> = <span class="ͼi">HighSec</span>; }</div><div class="cm-line"><br></div><div class="cm-line"><span class="ͼm">// The type alias gives us a more convenient way to "call" the type operator</span></div><div class="cm-line"><span class="ͼb">type</span> <span class="ͼi">MaxLevel</span>&lt;<span class="ͼi">L</span>, <span class="ͼi">R</span>&gt; = &lt;<span class="ͼi">L</span> <span class="ͼb">as</span> <span class="ͼi">ComputeMaxLevel</span>&lt;<span class="ͼi">R</span>&gt;&gt;::<span class="ͼi">Output</span>;</div></div></div></div></div><div class="aside block">The most confusing part is the <a href="#def-MaxLevel" class="ref"><code>MaxLevel</code></a> alias. In brief: <code>L as ComputeMaxLevel&lt;R&gt;</code> says "treat <code>L</code> as the trait object <code>ComputeMaxLevel&lt;R&gt;</code>". This is necessary since multiple computation traits may have associated <code>Output</code> with <code>L</code>, so the explicit cast disambiguates the <code>MaxLevel</code> computation from the rest.</div><p>Here’s an example of using the type operator:</p><div class="listing"><div class="cm-editor ͼ1 ͼ2 ͼo"><div aria-live="polite" style="position: absolute; top: -10000px;"></div><div tabindex="-1" class="cm-scroller"><div class="cm-gutters" aria-hidden="true" style="min-height: 42px; position: sticky;"><div class="cm-gutter cm-lineNumbers"><div class="cm-gutterElement" style="height: 0px; visibility: hidden; pointer-events: none;">9</div><div class="cm-gutterElement" style="height: 14px;">1</div><div class="cm-gutterElement" style="height: 14px;">2</div><div class="cm-gutterElement" style="height: 14px;">3</div></div></div><div spellcheck="false" autocorrect="off" autocapitalize="off" translate="no" contenteditable="false" class="cm-content" style="tab-size: 4" role="textbox" aria-multiline="true"><div class="cm-line"><span class="ͼb">let</span> <span class="ͼb">_</span> : <span class="ͼi">MaxLevel</span>&lt;<span class="ͼi">HighSec</span>, <span class="ͼi">LowSec</span>&gt; = HighSec; <span class="ͼm">// ok</span></div><div class="cm-line"><span class="ͼb">let</span> <span class="ͼb">_</span> : <span class="ͼi">MaxLevel</span>&lt;<span class="ͼi">LowSec</span> , <span class="ͼi">LowSec</span>&gt; = LowSec;  <span class="ͼm">// ok</span></div><div class="cm-line"><span class="ͼb">let</span> <span class="ͼb">_</span> : <span class="ͼi">MaxLevel</span>&lt;<span class="ͼi">LowSec</span> , <span class="ͼi">LowSec</span>&gt; = HighSec; <span class="ͼm">// type error</span></div></div></div></div></div><p>Now, we can implement <code>SecureVec::push</code> in one method:</p><div class="listing"><div class="cm-editor ͼ1 ͼ2 ͼo"><div aria-live="polite" style="position: absolute; top: -10000px;"></div><div tabindex="-1" class="cm-scroller"><div class="cm-gutters" aria-hidden="true" style="min-height: 196px; position: sticky;"><div class="cm-gutter cm-lineNumbers"><div class="cm-gutterElement" style="height: 0px; visibility: hidden; pointer-events: none;">99</div><div class="cm-gutterElement" style="height: 14px;">1</div><div class="cm-gutterElement" style="height: 14px;">2</div><div class="cm-gutterElement" style="height: 14px;">3</div><div class="cm-gutterElement" style="height: 14px;">4</div><div class="cm-gutterElement" style="height: 14px;">5</div><div class="cm-gutterElement" style="height: 14px;">6</div><div class="cm-gutterElement" style="height: 14px;">7</div><div class="cm-gutterElement" style="height: 14px;">8</div><div class="cm-gutterElement" style="height: 14px;">9</div><div class="cm-gutterElement" style="height: 14px;">10</div><div class="cm-gutterElement" style="height: 14px;">11</div><div class="cm-gutterElement" style="height: 14px;">12</div><div class="cm-gutterElement" style="height: 14px;">13</div><div class="cm-gutterElement" style="height: 14px;">14</div></div></div><div spellcheck="false" autocorrect="off" autocapitalize="off" translate="no" contenteditable="false" class="cm-content" style="tab-size: 4" role="textbox" aria-multiline="true"><div class="cm-line"><span class="ͼb">impl</span>&lt;<span class="ͼi">T</span>, <span class="ͼi">VecLevel</span>&gt; <span class="ͼi">SecureVec</span>&lt;<span class="ͼi">T</span>, <span class="ͼi">VecLevel</span>&gt; {</div><div class="cm-line">  <span class="ͼb">pub</span> <span class="ͼb">fn</span> <span class="ͼg">push</span>&lt;<span class="ͼi">ItemLevel</span>&gt;(</div><div class="cm-line">    <span class="ͼb">mut</span> <span class="ͼb">self</span>,</div><div class="cm-line">    <span class="ͼg">t</span>: <span class="ͼi">Item</span>&lt;<span class="ͼi">T</span>, <span class="ͼi">ItemLevel</span>&gt;,</div><div class="cm-line">  ) -&gt; <span class="ͼi">SecureVec</span>&lt;<span class="ͼi">T</span>, <span class="ͼi">MaxLevel</span>&lt;<span class="ͼi">ItemLevel</span>, <span class="ͼi">VecLevel</span>&gt;&gt;</div><div class="cm-line">  <span class="ͼb">where</span></div><div class="cm-line">    <span class="ͼi">ItemLevel</span>: <span class="ͼi">ComputeMaxLevel</span>&lt;<span class="ͼi">VecLevel</span>&gt;,</div><div class="cm-line">  {</div><div class="cm-line">    <span class="ͼb">unsafe</span> {</div><div class="cm-line">      <span class="ͼb">self</span>.items.push(transmute(t));</div><div class="cm-line">      transmute(<span class="ͼb">self</span>)</div><div class="cm-line">    }</div><div class="cm-line">  }</div><div class="cm-line">}</div></div></div></div></div><p>Notice the usage of <a href="#def-MaxLevel" class="ref"><code>MaxLevel</code></a> in the return type of <code>push</code>. This is the key use of the type operator as a type-level computation. The other main component is the <code>where</code> clause: when used generically (over any possible <code>ItemLevel</code>), we have to use a trait bound to ensure that <a href="#def-ComputeMaxLevel" class="ref"><code>ComputeMaxLevel</code></a> can be "called" on <code>ItemLevel</code>.</p><p>Excellent! We’ve now used a type-level computation to more abstractly specify typestate in our information flow control API. Next, we’ll look at an example with a more complex type-level program.</p></section><section><h1 class="section-title"><div id="def-section-2" class="definition"><span class="section-number">2</span>  Two-Party Communication Protocols</div></h1><p>When two parties synchronously communicate with each other (e.g. a client and server exchanging information), that communication protocol can be modeled as a session type. We’re going to look at session types <a href="https://munksgaard.me/papers/laumann-munksgaard-larsen.pdf">implemented in Rust</a>. While their full implementation is beyond the scope of the post (see the linked paper or my <a href="http://cs242.stanford.edu/f19/lectures/09-1-session-types">course notes</a>), I will focus on the aspects of session types that showcase type-level programming.</p><p>Session types are a domain-specific language of state machines, described by this grammar:</p><div><div class="tex block"><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 15em; vertical-align: -7.25em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 7.75em;"><span style="top: -9.75em;"><span class="pstrut" style="height: 2.84em;"></span><span class="mord"></span></span><span style="top: -8.25em;"><span class="pstrut" style="height: 2.84em;"></span><span class="mord"></span></span><span style="top: -6.75em;"><span class="pstrut" style="height: 2.84em;"></span><span class="mord"></span></span><span style="top: -5.25em;"><span class="pstrut" style="height: 2.84em;"></span><span class="mord"></span></span><span style="top: -3.75em;"><span class="pstrut" style="height: 2.84em;"></span><span class="mord"></span></span><span style="top: -2.25em;"><span class="pstrut" style="height: 2.84em;"></span><span class="mord"></span></span><span style="top: -0.75em;"><span class="pstrut" style="height: 2.84em;"></span><span class="mord"></span></span><span style="top: 0.75em;"><span class="pstrut" style="height: 2.84em;"></span><span class="mord"></span></span><span style="top: 2.25em;"><span class="pstrut" style="height: 2.84em;"></span><span class="mord"></span></span><span style="top: 3.75em;"><span class="pstrut" style="height: 2.84em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 7.25em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 7.75em;"><span style="top: -9.91em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span><span id="def-tex_num" class="definition"><span class="enclosing" data-defanchor="tex_num"><span class="mord"><span class="mord mathsf" style="margin-right: 0.01389em;">Number</span></span></span></span></span></span><span style="top: -8.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span><span id="def-tex_ty" class="definition"><span class="enclosing" data-defanchor="tex_ty"><span class="mord"><span class="mord mathsf">Type</span></span></span></span></span></span><span style="top: -6.91em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span><span id="def-tex_sessty" class="definition"><span class="enclosing" data-defanchor="tex_sessty"><span class="mord"><span class="mord mathsf">SessionType</span></span></span></span></span></span><span style="top: -5.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span></span></span><span style="top: -3.91em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span></span></span><span style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span></span></span><span style="top: -0.91em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span></span></span><span style="top: 0.59em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span></span></span><span style="top: 2.09em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span></span></span><span style="top: 3.59em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 7.25em;"><span></span></span></span></span></span><span class="arraycolsep" style="width: 1em;"></span><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 7.75em;"><span style="top: -9.91em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mspace nobreak">&nbsp;</span></span></span><span style="top: -8.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mspace nobreak">&nbsp;</span></span></span><span style="top: -6.91em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mspace nobreak">&nbsp;</span></span></span><span style="top: -5.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span style="top: -3.91em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span style="top: -0.91em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span style="top: 0.59em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span style="top: 2.09em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span style="top: 3.59em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 7.25em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 7.75em;"><span style="top: -9.91em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span><span class="mord mathnormal">n</span></span></span><span style="top: -8.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span><span class="mord mathnormal" style="margin-right: 0.1132em;">τ</span></span></span><span style="top: -6.91em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span><span class="mord mathnormal" style="margin-right: 0.03588em;">σ</span></span></span><span style="top: -5.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span></span></span><span style="top: -3.91em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span></span></span><span style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span></span></span><span style="top: -0.91em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span></span></span><span style="top: 0.59em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span></span></span><span style="top: 2.09em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span></span></span><span style="top: 3.59em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 7.25em;"><span></span></span></span></span></span><span class="arraycolsep" style="width: 1em;"></span><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 7.75em;"><span style="top: -9.75em;"><span class="pstrut" style="height: 2.84em;"></span><span class="mord"></span></span><span style="top: -8.25em;"><span class="pstrut" style="height: 2.84em;"></span><span class="mord"></span></span><span style="top: -6.75em;"><span class="pstrut" style="height: 2.84em;"></span><span class="mord"></span></span><span style="top: -5.25em;"><span class="pstrut" style="height: 2.84em;"></span><span class="mord"></span></span><span style="top: -3.75em;"><span class="pstrut" style="height: 2.84em;"></span><span class="mord"></span></span><span style="top: -2.25em;"><span class="pstrut" style="height: 2.84em;"></span><span class="mord"></span></span><span style="top: -0.75em;"><span class="pstrut" style="height: 2.84em;"></span><span class="mord"></span></span><span style="top: 0.75em;"><span class="pstrut" style="height: 2.84em;"></span><span class="mord"></span></span><span style="top: 2.25em;"><span class="pstrut" style="height: 2.84em;"></span><span class="mord"></span></span><span style="top: 3.75em;"><span class="pstrut" style="height: 2.84em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 7.25em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 7.75em;"><span style="top: -9.91em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span></span></span><span style="top: -8.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span></span></span><span style="top: -6.91em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">::=</span></span></span><span style="top: -5.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span></span></span><span style="top: -3.91em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span></span></span><span style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span></span></span><span style="top: -0.91em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span></span></span><span style="top: 0.59em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span></span></span><span style="top: 2.09em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span></span></span><span style="top: 3.59em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 7.25em;"><span></span></span></span></span></span><span class="arraycolsep" style="width: 1em;"></span><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 4.75em;"><span style="top: -6.75em;"><span class="pstrut" style="height: 2.84em;"></span><span class="mord"></span></span><span style="top: -5.25em;"><span class="pstrut" style="height: 2.84em;"></span><span class="mord"></span></span><span style="top: -3.75em;"><span class="pstrut" style="height: 2.84em;"></span><span class="mord"></span></span><span style="top: -2.25em;"><span class="pstrut" style="height: 2.84em;"></span><span class="mord"></span></span><span style="top: -0.75em;"><span class="pstrut" style="height: 2.84em;"></span><span class="mord"></span></span><span style="top: 0.75em;"><span class="pstrut" style="height: 2.84em;"></span><span class="mord"></span></span><span style="top: 2.25em;"><span class="pstrut" style="height: 2.84em;"></span><span class="mord"></span></span><span style="top: 3.75em;"><span class="pstrut" style="height: 2.84em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 7.25em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 4.75em;"><span style="top: -6.91em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">∣</span></span></span><span style="top: -5.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.2778em;"></span><span id="def-tex_sesstyrecv" class="definition"><span class="enclosing" data-defanchor="tex_sesstyrecv"><span id="def-sesstyrecv" class="definition"><span class="enclosing" data-defanchor="sesstyrecv"><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_sesstyrecv"><span class="mord"><span class="mord mathsf" style="margin-right: 0.01389em;">recv</span></span><span class="mspace nobreak">&nbsp;</span><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_ty"><span class="mord mathnormal" style="margin-right: 0.1132em;">τ</span></span></span><span class="mpunct">;</span><span class="mspace nobreak">&nbsp;</span><span class="mspace" style="margin-right: 0.1667em;"></span><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_sessty"><span class="mord mathnormal" style="margin-right: 0.03588em;">σ</span></span></span></span></span></span></span></span></span></span></span><span style="top: -3.91em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.2778em;"></span><span id="def-tex_sesstysend" class="definition"><span class="enclosing" data-defanchor="tex_sesstysend"><span id="def-sesstysend" class="definition"><span class="enclosing" data-defanchor="sesstysend"><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_sesstysend"><span class="mord"><span class="mord mathsf">send</span></span><span class="mspace nobreak">&nbsp;</span><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_ty"><span class="mord mathnormal" style="margin-right: 0.1132em;">τ</span></span></span><span class="mpunct">;</span><span class="mspace nobreak">&nbsp;</span><span class="mspace" style="margin-right: 0.1667em;"></span><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_sessty"><span class="mord mathnormal" style="margin-right: 0.03588em;">σ</span></span></span></span></span></span></span></span></span></span></span><span style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.2778em;"></span><span id="def-tex_sesstychoose" class="definition"><span class="enclosing" data-defanchor="tex_sesstychoose"><span id="def-sesstychoose" class="definition"><span class="enclosing" data-defanchor="sesstychoose"><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_sesstychoose"><span class="mord"><span class="mord mathsf">choose</span></span><span class="mspace nobreak">&nbsp;</span><span class="mopen">{</span><span class="mord mathnormal">L</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">⇒</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mord"><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_sessty"><span class="mord mathnormal" style="margin-right: 0.03588em;">σ</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span style="top: -2.55em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mord mathnormal" style="margin-right: 0.00773em;">R</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">⇒</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mord"><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_sessty"><span class="mord mathnormal" style="margin-right: 0.03588em;">σ</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span style="top: -2.55em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mclose">}</span></span></span></span></span></span></span></span></span><span style="top: -0.91em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.2778em;"></span><span id="def-tex_sesstyoffer" class="definition"><span class="enclosing" data-defanchor="tex_sesstyoffer"><span id="def-sesstyoffer" class="definition"><span class="enclosing" data-defanchor="sesstyoffer"><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_sesstyoffer"><span class="mord"><span class="mord mathsf" style="margin-right: 0.01389em;">offer</span></span><span class="mspace nobreak">&nbsp;</span><span class="mopen">{</span><span class="mord mathnormal">L</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">⇒</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mord"><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_sessty"><span class="mord mathnormal" style="margin-right: 0.03588em;">σ</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span style="top: -2.55em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mord mathnormal" style="margin-right: 0.00773em;">R</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">⇒</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mord"><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_sessty"><span class="mord mathnormal" style="margin-right: 0.03588em;">σ</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span style="top: -2.55em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mclose">}</span></span></span></span></span></span></span></span></span><span style="top: 0.59em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.2778em;"></span><span id="def-tex_sesstylabel" class="definition"><span class="enclosing" data-defanchor="tex_sesstylabel"><span id="def-sesstylabel" class="definition"><span class="enclosing" data-defanchor="sesstylabel"><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_sesstylabel"><span class="mord"><span class="mord mathsf">label</span></span><span class="mpunct">;</span><span class="mspace nobreak">&nbsp;</span><span class="mspace" style="margin-right: 0.1667em;"></span><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_sessty"><span class="mord mathnormal" style="margin-right: 0.03588em;">σ</span></span></span></span></span></span></span></span></span></span></span><span style="top: 2.09em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.2778em;"></span><span id="def-tex_sesstygoto" class="definition"><span class="enclosing" data-defanchor="tex_sesstygoto"><span id="def-sesstygoto" class="definition"><span class="enclosing" data-defanchor="sesstygoto"><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_sesstygoto"><span class="mord"><span class="mord mathsf">goto</span></span><span class="mspace nobreak">&nbsp;</span><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_num"><span class="mord mathnormal">n</span></span></span></span></span></span></span></span></span></span></span><span style="top: 3.59em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.2778em;"></span><span id="def-tex_sesstyend" class="definition"><span class="enclosing" data-defanchor="tex_sesstyend"><span id="def-sesstyend" class="definition"><span class="enclosing" data-defanchor="sesstyend"><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_sesstyend"><span class="mord mathnormal">ε</span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 7.25em;"><span></span></span></span></span></span><span class="arraycolsep" style="width: 1em;"></span><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 3.25em;"><span style="top: -5.25em;"><span class="pstrut" style="height: 2.84em;"></span><span class="mord"></span></span><span style="top: -3.75em;"><span class="pstrut" style="height: 2.84em;"></span><span class="mord"></span></span><span style="top: -2.25em;"><span class="pstrut" style="height: 2.84em;"></span><span class="mord"></span></span><span style="top: -0.75em;"><span class="pstrut" style="height: 2.84em;"></span><span class="mord"></span></span><span style="top: 0.75em;"><span class="pstrut" style="height: 2.84em;"></span><span class="mord"></span></span><span style="top: 2.25em;"><span class="pstrut" style="height: 2.84em;"></span><span class="mord"></span></span><span style="top: 3.75em;"><span class="pstrut" style="height: 2.84em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 7.25em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 3.25em;"><span style="top: -5.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span><span class="mord text"><span class="mord">receive&nbsp;message&nbsp;type&nbsp;</span><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_ty"><span class="mord mathnormal" style="margin-right: 0.1132em;">τ</span></span></span></span></span></span><span style="top: -3.91em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span><span class="mord text"><span class="mord">send&nbsp;message&nbsp;type&nbsp;</span><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_ty"><span class="mord mathnormal" style="margin-right: 0.1132em;">τ</span></span></span></span></span></span><span style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span><span class="mord text"><span class="mord">choose&nbsp;sub-protocol</span></span></span></span><span style="top: -0.91em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span><span class="mord text"><span class="mord">offer&nbsp;sub-protocol</span></span></span></span><span style="top: 0.59em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span><span class="mord text"><span class="mord">label&nbsp;point</span></span></span></span><span style="top: 2.09em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span><span class="mord text"><span class="mord">go&nbsp;to&nbsp;label</span></span></span></span><span style="top: 3.59em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span><span class="mord text"><span class="mord">end&nbsp;protocol</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 7.25em;"><span></span></span></span></span></span></span></span></span></span></span></span></div></div><p>For example, this session type describes a ping server that sends and receives a ping in a loop, exiting on demand. The label/goto scheme uses <a href="https://en.wikipedia.org/wiki/De_Bruijn_index">de Bruijn indices</a> to locally encode label names as integers.</p><div class="tex block"><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_sesstylabel"><span class="mord"><span class="mord mathsf">label</span></span><span class="mpunct">;</span><span class="mspace nobreak">&nbsp;</span><span class="mspace" style="margin-right: 0.1667em;"></span><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_sesstyoffer"><span class="mord"><span class="mord mathsf" style="margin-right: 0.01389em;">offer</span></span><span class="mspace nobreak">&nbsp;</span><span class="mopen">{</span><span class="mord"><span class="mord mathsf">run</span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">⇒</span><span class="mspace" style="margin-right: 0.2778em;"></span><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_sesstysend"><span class="mord"><span class="mord mathsf">send</span></span><span class="mspace nobreak">&nbsp;</span><span class="mord"><span class="mord mathsf" style="margin-right: 0.01389em;">ping</span></span><span class="mpunct">;</span><span class="mspace nobreak">&nbsp;</span><span class="mspace" style="margin-right: 0.1667em;"></span><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_sesstyrecv"><span class="mord"><span class="mord mathsf" style="margin-right: 0.01389em;">recv</span></span><span class="mspace nobreak">&nbsp;</span><span class="mord"><span class="mord mathsf" style="margin-right: 0.01389em;">ping</span></span><span class="mpunct">;</span><span class="mspace nobreak">&nbsp;</span><span class="mspace" style="margin-right: 0.1667em;"></span><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_sesstygoto"><span class="mord"><span class="mord mathsf">goto</span></span><span class="mspace nobreak">&nbsp;</span><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_num"><span class="mord">0</span><span class="mspace" style="margin-right: 0.2778em;"></span></span></span></span></span></span></span></span></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mord"><span class="mord mathsf">quit</span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">⇒</span><span class="mspace" style="margin-right: 0.2778em;"></span><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_sesstyend"><span class="mord mathnormal">ε</span></span></span><span class="mclose">}</span></span></span></span></span></span></span></span></span></div><p>The grammar, and this example, can be encoded in Rust like so:</p><div class="listing"><div class="cm-editor ͼ1 ͼ2 ͼo"><div aria-live="polite" style="position: absolute; top: -10000px;"></div><div tabindex="-1" class="cm-scroller"><div class="cm-gutters" aria-hidden="true" style="min-height: 252px; position: sticky;"><div class="cm-gutter cm-lineNumbers"><div class="cm-gutterElement" style="height: 0px; visibility: hidden; pointer-events: none;">99</div><div class="cm-gutterElement" style="height: 14px;">1</div><div class="cm-gutterElement" style="height: 14px;">2</div><div class="cm-gutterElement" style="height: 14px;">3</div><div class="cm-gutterElement" style="height: 14px;">4</div><div class="cm-gutterElement" style="height: 14px;">5</div><div class="cm-gutterElement" style="height: 14px;">6</div><div class="cm-gutterElement" style="height: 14px;">7</div><div class="cm-gutterElement" style="height: 14px;">8</div><div class="cm-gutterElement" style="height: 14px;">9</div><div class="cm-gutterElement" style="height: 14px;">10</div><div class="cm-gutterElement" style="height: 14px;">11</div><div class="cm-gutterElement" style="height: 14px;">12</div><div class="cm-gutterElement" style="height: 14px;">13</div><div class="cm-gutterElement" style="height: 14px;">14</div><div class="cm-gutterElement" style="height: 14px;">15</div><div class="cm-gutterElement" style="height: 14px;">16</div><div class="cm-gutterElement" style="height: 14px;">17</div><div class="cm-gutterElement" style="height: 14px;">18</div></div></div><div spellcheck="false" autocorrect="off" autocapitalize="off" translate="no" contenteditable="false" class="cm-content" style="tab-size: 4" role="textbox" aria-multiline="true"><div class="cm-line"><span class="ͼb">struct</span> <span class="ͼi">Send</span>&lt;<span class="ͼi">T</span>, <span class="ͼi">S</span>&gt;(<span class="ͼi">PhantomData</span>&lt;(<span class="ͼi">T</span>, <span class="ͼi">S</span>)&gt;);</div><div class="cm-line"><span class="ͼb">struct</span> <span class="ͼi">Recv</span>&lt;<span class="ͼi">T</span>, <span class="ͼi">S</span>&gt;(<span class="ͼi">PhantomData</span>&lt;(<span class="ͼi">T</span>, <span class="ͼi">S</span>)&gt;);</div><div class="cm-line"><span class="ͼb">struct</span> <span class="ͼi">Offer</span>&lt;<span class="ͼi">Left</span>, <span class="ͼi">Right</span>&gt;(<span class="ͼi">PhantomData</span>&lt;(<span class="ͼi">Left</span>, <span class="ͼi">Right</span>)&gt;);</div><div class="cm-line"><span class="ͼb">struct</span> <span class="ͼi">Choose</span>&lt;<span class="ͼi">Left</span>, <span class="ͼi">Right</span>&gt;(<span class="ͼi">PhantomData</span>&lt;(<span class="ͼi">Left</span>, <span class="ͼi">Right</span>)&gt;);</div><div class="cm-line"><span class="ͼb">struct</span> <span class="ͼi">Label</span>&lt;<span class="ͼi">S</span>&gt;(<span class="ͼi">PhantomData</span>&lt;<span class="ͼi">S</span>&gt;);</div><div class="cm-line"><span class="ͼb">struct</span> <span class="ͼi">Goto</span>&lt;<span class="ͼi">N</span>&gt;(<span class="ͼi">PhantomData</span>&lt;<span class="ͼi">N</span>&gt;);</div><div class="cm-line"><span class="ͼb">struct</span> <span class="ͼi">Z</span>;</div><div class="cm-line"><span class="ͼb">struct</span> <span class="ͼi">S</span>&lt;<span class="ͼi">N</span>&gt;(<span class="ͼi">PhantomData</span>&lt;<span class="ͼi">N</span>&gt;); <span class="ͼm">// Peano encoding for natural numbers</span></div><div class="cm-line"><span class="ͼb">struct</span> <span class="ͼi">Close</span>;</div><div class="cm-line"><br></div><div class="cm-line"><span class="ͼb">struct</span> <span class="ͼi">Ping</span>;</div><div class="cm-line"><span class="ͼb">type</span> <span class="ͼi">PingServer</span> =</div><div class="cm-line">  <span class="ͼi">Label</span>&lt;</div><div class="cm-line">    <span class="ͼi">Offer</span>&lt;</div><div class="cm-line">      <span class="ͼi">Send</span>&lt;<span class="ͼi">Ping</span>,</div><div class="cm-line">        <span class="ͼi">Recv</span>&lt;<span class="ͼi">Ping</span>,</div><div class="cm-line">        <span class="ͼi">Goto</span>&lt;<span class="ͼi">Z</span>&gt;&gt;&gt;,</div><div class="cm-line">      <span class="ͼi">Close</span>&gt;&gt;;</div></div></div></div></div><p>The runtime communication API uses the type-state concept as a channel whose type changes as the protocol advances. Initially, a <code>Chan</code> is created for the server and the client (the “dual” of the server). Here’s an example where the type annotations show the change.</p><div class="listing"><div class="cm-editor ͼ1 ͼ2 ͼo"><div aria-live="polite" style="position: absolute; top: -10000px;"></div><div tabindex="-1" class="cm-scroller"><div class="cm-gutters" aria-hidden="true" style="min-height: 252px; position: sticky;"><div class="cm-gutter cm-lineNumbers"><div class="cm-gutterElement" style="height: 0px; visibility: hidden; pointer-events: none;">99</div><div class="cm-gutterElement" style="height: 14px;">1</div><div class="cm-gutterElement" style="height: 14px;">2</div><div class="cm-gutterElement" style="height: 14px;">3</div><div class="cm-gutterElement" style="height: 14px;">4</div><div class="cm-gutterElement" style="height: 14px;">5</div><div class="cm-gutterElement" style="height: 14px;">6</div><div class="cm-gutterElement" style="height: 14px;">7</div><div class="cm-gutterElement" style="height: 14px;">8</div><div class="cm-gutterElement" style="height: 14px;">9</div><div class="cm-gutterElement" style="height: 14px;">10</div><div class="cm-gutterElement" style="height: 14px;">11</div><div class="cm-gutterElement" style="height: 14px;">12</div><div class="cm-gutterElement" style="height: 14px;">13</div><div class="cm-gutterElement" style="height: 14px;">14</div><div class="cm-gutterElement" style="height: 14px;">15</div><div class="cm-gutterElement" style="height: 14px;">16</div><div class="cm-gutterElement" style="height: 14px;">17</div><div class="cm-gutterElement" style="height: 14px;">18</div></div></div><div spellcheck="false" autocorrect="off" autocapitalize="off" translate="no" contenteditable="false" class="cm-content" style="tab-size: 4;" role="textbox" aria-multiline="true"><div class="cm-line"><span class="ͼb">fn</span> <span class="ͼg">example_ping_server</span>() {</div><div class="cm-line">  <span class="ͼb">let</span> (<span class="ͼg">c</span>, <span class="ͼb">_</span>): (<span class="ͼi">Chan</span>&lt;(), <span class="ͼi">PingServer</span>&gt;,</div><div class="cm-line">               <span class="ͼi">Chan</span>&lt;(), <span class="ͼi">Dual</span>&lt;<span class="ͼi">PingServer</span>&gt;) = <span class="ͼi">Chan</span>::new();</div><div class="cm-line">  <span class="ͼb">let</span> <span class="ͼb">mut</span> <span class="ͼg">c</span>: <span class="ͼi">Chan</span>&lt;(<span class="ͼi">Offer</span>&lt;<span class="ͼb">_</span>,<span class="ͼb">_</span>&gt;, ()), <span class="ͼi">Offer</span>&lt;<span class="ͼb">_</span>,<span class="ͼb">_</span>&gt;&gt; = c.label();</div><div class="cm-line">  <span class="ͼb">loop</span> {</div><div class="cm-line">    c = <span class="ͼb">match</span> c.offer() {</div><div class="cm-line">      <span class="ͼi">Branch</span>::<span class="ͼi">Left</span>(<span class="ͼg">c</span>) =&gt; {</div><div class="cm-line">        <span class="ͼb">let</span> <span class="ͼg">c</span>: <span class="ͼi">Chan</span>&lt;<span class="ͼb">_</span>, <span class="ͼi">Recv</span>&lt;<span class="ͼb">_</span>,<span class="ͼb">_</span>&gt;&gt; = c.<span class="ͼi">send</span>(<span class="ͼi">Ping</span>);</div><div class="cm-line">        <span class="ͼb">let</span> (<span class="ͼg">c</span>, <span class="ͼg">Ping</span>): (<span class="ͼi">Chan</span>&lt;<span class="ͼb">_</span>, <span class="ͼi">Goto</span>&lt;<span class="ͼb">_</span>&gt;&gt;, <span class="ͼb">_</span>) = c.recv();</div><div class="cm-line">        c.goto()</div><div class="cm-line">      },</div><div class="cm-line">      <span class="ͼi">Branch</span>::<span class="ͼi">Right</span>(<span class="ͼg">c</span>) =&gt; {</div><div class="cm-line">        c.close();</div><div class="cm-line">        <span class="ͼb">return</span>;</div><div class="cm-line">      }</div><div class="cm-line">    }</div><div class="cm-line">  }</div><div class="cm-line">}</div></div></div></div></div><p>Note that the <code>Chan</code> has two type arguments: an environment <code>Env</code> and a current action <code>Sigma</code>. The environment contains a list of session types generated by calls to <code>label</code>. When we <code>goto</code>, we look up the corresponding type in the <code>Env</code> list and make that the type of the current channel.</p><div class="aside block"><p>You might wonder how the methods like c.offer() and c.recv() are actually implemented. Once the session type framework is established, they aren’t very interesting — perform an operation, then transmute to the new type-state. For example, recv:</p><div class="listing"><div class="cm-editor ͼ1 ͼ2 ͼo"><div aria-live="polite" style="position: absolute; top: -10000px;"></div><div tabindex="-1" class="cm-scroller"><div class="cm-gutters" aria-hidden="true" style="min-height: 154px; position: sticky;"><div class="cm-gutter cm-lineNumbers"><div class="cm-gutterElement" style="height: 0px; visibility: hidden; pointer-events: none;">99</div><div class="cm-gutterElement" style="height: 14px;">1</div><div class="cm-gutterElement" style="height: 14px;">2</div><div class="cm-gutterElement" style="height: 14px;">3</div><div class="cm-gutterElement" style="height: 14px;">4</div><div class="cm-gutterElement" style="height: 14px;">5</div><div class="cm-gutterElement" style="height: 14px;">6</div><div class="cm-gutterElement" style="height: 14px;">7</div><div class="cm-gutterElement" style="height: 14px;">8</div><div class="cm-gutterElement" style="height: 14px;">9</div><div class="cm-gutterElement" style="height: 14px;">10</div><div class="cm-gutterElement" style="height: 14px;">11</div></div></div><div spellcheck="false" autocorrect="off" autocapitalize="off" translate="no" contenteditable="false" class="cm-content" style="tab-size: 4" role="textbox" aria-multiline="true"><div class="cm-line"><span class="ͼb">impl</span>&lt;<span class="ͼi">Env</span>, <span class="ͼi">T</span>, <span class="ͼi">S</span>&gt; <span class="ͼi">Chan</span>&lt;<span class="ͼi">Env</span>, <span class="ͼi">Recv</span>&lt;<span class="ͼi">T</span>, <span class="ͼi">S</span>&gt;&gt;</div><div class="cm-line"><span class="ͼb">where</span></div><div class="cm-line">  <span class="ͼi">T</span>: <span class="ͼi">marker</span>::<span class="ͼi">Send</span> + <span class="ͼk">'static</span>,</div><div class="cm-line">{</div><div class="cm-line">  <span class="ͼb">pub</span> <span class="ͼb">fn</span> <span class="ͼg">recv</span>(<span class="ͼb">self</span>) -&gt; (<span class="ͼi">Chan</span>&lt;<span class="ͼi">Env</span>, <span class="ͼi">S</span>&gt;, <span class="ͼi">T</span>) {</div><div class="cm-line">    <span class="ͼb">unsafe</span> {</div><div class="cm-line">      <span class="ͼb">let</span> <span class="ͼg">x</span> = <span class="ͼb">self</span>.read();</div><div class="cm-line">      (transmute(<span class="ͼb">self</span>), x)</div><div class="cm-line">    }</div><div class="cm-line">  }</div><div class="cm-line">}</div></div></div></div></div><p>See the session-types crate for the full implementation if you’re interested.</p></div><p>We’re going to look at two type-level operations in this framework:</p><ul><li><p>Dual types: given a description of the protocol from one party’s perspective (e.g. <a href="#def-PingServer" class="ref"><code>PingServer</code></a>) we can automatically generate a matching <code>PingClient</code> protocol. This is the <code>Dual&lt;PingServer&gt;</code> reference above.</p></li><li><p>Labels and gotos: to implement <code>label</code>/<code>goto</code>, we need a notion of a dynamically-sized list of types that we can push, index, and change.</p></li></ul><section><h2 class="section-title"><div id="def-section-2.1" class="definition"><span class="section-number">2.1</span>  Dual Types</div></h2><p>The idea of a dual session type is that if I’m sending to you, you should be receiving from me. Similarly, if I offer to branch left or right, you should be choosing which branch to take. In Rust, the dual of <code>Send&lt;i32, Close&gt;</code> should be <code>Recv&lt;i32, Close&gt;</code>.</p><p>Dual session types are useful because they prevent errors. If you had to manually specify both halves of the protocol, you might accidentally mis-match one side.</p><p>We can write down an inductive procedure for generating a dual type as follows, using the notation <span class="tex"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.6306em;"></span><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="dual"><span class="mord overline"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6306em;"><span style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_sessty"><span class="mord mathnormal" style="margin-right: 0.03588em;">σ</span></span></span></span></span><span style="top: -3.5506em;"><span class="pstrut" style="height: 3em;"></span><span class="overline-line" style="border-bottom-width: 0.04em;"></span></span></span></span></span></span></span></span></span></span></span></span> to mean "the dual of <span class="tex"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_sessty"><span class="mord mathnormal" style="margin-right: 0.03588em;">σ</span></span></span></span></span></span></span>".</p><div id="def-dual" class="definition"><div class="tex block"><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 9.2189em; vertical-align: -4.3594em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 4.8594em;"><span style="top: -6.965em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="dual"><span class="mord overline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8944em;"><span style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_sesstysend"><span class="mord"><span class="mord mathsf">send</span></span><span class="mspace nobreak">&nbsp;</span><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_ty"><span class="mord mathnormal" style="margin-right: 0.1132em;">τ</span></span></span><span class="mpunct">;</span><span class="mspace nobreak">&nbsp;</span><span class="mspace" style="margin-right: 0.1667em;"></span><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_sessty"><span class="mord mathnormal" style="margin-right: 0.03588em;">σ</span></span></span></span></span></span></span><span style="top: -3.8144em;"><span class="pstrut" style="height: 3em;"></span><span class="overline-line" style="border-bottom-width: 0.04em;"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.1944em;"><span></span></span></span></span></span></span></span></span></span><span style="top: -5.465em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="dual"><span class="mord overline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.6444em;"><span style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_sesstyrecv"><span class="mord"><span class="mord mathsf" style="margin-right: 0.01389em;">recv</span></span><span class="mspace nobreak">&nbsp;</span><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_ty"><span class="mord mathnormal" style="margin-right: 0.1132em;">τ</span></span></span><span class="mpunct">;</span><span class="mspace nobreak">&nbsp;</span><span class="mspace" style="margin-right: 0.1667em;"></span><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_sessty"><span class="mord mathnormal" style="margin-right: 0.03588em;">σ</span></span></span></span></span></span></span><span style="top: -3.5644em;"><span class="pstrut" style="height: 3em;"></span><span class="overline-line" style="border-bottom-width: 0.04em;"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.1944em;"><span></span></span></span></span></span></span></span></span></span><span style="top: -3.855em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="dual"><span class="mord overline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.95em;"><span style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_sesstychoose"><span class="mord"><span class="mord mathsf">choose</span></span><span class="mspace nobreak">&nbsp;</span><span class="mopen">{</span><span class="mord mathnormal">L</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">⇒</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mord"><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_sessty"><span class="mord mathnormal" style="margin-right: 0.03588em;">σ</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span style="top: -2.55em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mord mathnormal" style="margin-right: 0.00773em;">R</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">⇒</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mord"><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_sessty"><span class="mord mathnormal" style="margin-right: 0.03588em;">σ</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span style="top: -2.55em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mclose">}</span></span></span></span></span><span style="top: -3.87em;"><span class="pstrut" style="height: 3em;"></span><span class="overline-line" style="border-bottom-width: 0.04em;"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.25em;"><span></span></span></span></span></span></span></span></span></span><span style="top: -2.3006em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="dual"><span class="mord overline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8944em;"><span style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_sesstylabel"><span class="mord"><span class="mord mathsf">label</span></span><span class="mpunct">;</span><span class="mspace nobreak">&nbsp;</span><span class="mspace" style="margin-right: 0.1667em;"></span><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_sessty"><span class="mord mathnormal" style="margin-right: 0.03588em;">σ</span></span></span></span></span></span></span><span style="top: -3.8144em;"><span class="pstrut" style="height: 3em;"></span><span class="overline-line" style="border-bottom-width: 0.04em;"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.1944em;"><span></span></span></span></span></span></span></span></span></span><span style="top: -0.8006em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="dual"><span class="mord overline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.7714em;"><span style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_sesstygoto"><span class="mord"><span class="mord mathsf">goto</span></span><span class="mspace nobreak">&nbsp;</span><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_num"><span class="mord mathnormal">n</span></span></span></span></span></span></span><span style="top: -3.6914em;"><span class="pstrut" style="height: 3em;"></span><span class="overline-line" style="border-bottom-width: 0.04em;"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.1944em;"><span></span></span></span></span></span></span></span></span></span><span style="top: 0.6994em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="dual"><span class="mord overline"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6306em;"><span style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_sesstyend"><span class="mord mathnormal">ε</span></span></span></span></span><span style="top: -3.5506em;"><span class="pstrut" style="height: 3em;"></span><span class="overline-line" style="border-bottom-width: 0.04em;"></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 4.3594em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 4.8594em;"><span style="top: -6.965em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_sesstyrecv"><span class="mord"><span class="mord mathsf" style="margin-right: 0.01389em;">recv</span></span><span class="mspace nobreak">&nbsp;</span><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_ty"><span class="mord mathnormal" style="margin-right: 0.1132em;">τ</span></span></span><span class="mpunct">;</span><span class="mspace nobreak">&nbsp;</span><span class="mspace" style="margin-right: 0.1667em;"></span><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="dual"><span class="mord overline"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6306em;"><span style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_sessty"><span class="mord mathnormal" style="margin-right: 0.03588em;">σ</span></span></span></span></span><span style="top: -3.5506em;"><span class="pstrut" style="height: 3em;"></span><span class="overline-line" style="border-bottom-width: 0.04em;"></span></span></span></span></span></span></span></span></span></span></span></span><span style="top: -5.465em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_sesstysend"><span class="mord"><span class="mord mathsf">send</span></span><span class="mspace nobreak">&nbsp;</span><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_ty"><span class="mord mathnormal" style="margin-right: 0.1132em;">τ</span></span></span><span class="mpunct">;</span><span class="mspace nobreak">&nbsp;</span><span class="mspace" style="margin-right: 0.1667em;"></span><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="dual"><span class="mord overline"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6306em;"><span style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_sessty"><span class="mord mathnormal" style="margin-right: 0.03588em;">σ</span></span></span></span></span><span style="top: -3.5506em;"><span class="pstrut" style="height: 3em;"></span><span class="overline-line" style="border-bottom-width: 0.04em;"></span></span></span></span></span></span></span></span></span></span></span></span><span style="top: -3.855em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_sesstyoffer"><span class="mord"><span class="mord mathsf" style="margin-right: 0.01389em;">offer</span></span><span class="mspace nobreak">&nbsp;</span><span class="mopen">{</span><span class="mord mathnormal">L</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">⇒</span><span class="mspace" style="margin-right: 0.2778em;"></span><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="dual"><span class="mord overline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.6306em;"><span style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_sessty"><span class="mord mathnormal" style="margin-right: 0.03588em;">σ</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span style="top: -2.55em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span></span></span><span style="top: -3.5506em;"><span class="pstrut" style="height: 3em;"></span><span class="overline-line" style="border-bottom-width: 0.04em;"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span></span></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mord mathnormal" style="margin-right: 0.00773em;">R</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">⇒</span><span class="mspace" style="margin-right: 0.2778em;"></span><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="dual"><span class="mord overline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.6306em;"><span style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_sessty"><span class="mord mathnormal" style="margin-right: 0.03588em;">σ</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span style="top: -2.55em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span></span></span><span style="top: -3.5506em;"><span class="pstrut" style="height: 3em;"></span><span class="overline-line" style="border-bottom-width: 0.04em;"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span></span><span class="mclose">}</span></span></span></span></span><span style="top: -2.3006em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_sesstylabel"><span class="mord"><span class="mord mathsf">label</span></span><span class="mpunct">;</span><span class="mspace nobreak">&nbsp;</span><span class="mspace" style="margin-right: 0.1667em;"></span><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="dual"><span class="mord overline"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6306em;"><span style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_sessty"><span class="mord mathnormal" style="margin-right: 0.03588em;">σ</span></span></span></span></span><span style="top: -3.5506em;"><span class="pstrut" style="height: 3em;"></span><span class="overline-line" style="border-bottom-width: 0.04em;"></span></span></span></span></span></span></span></span></span></span></span></span><span style="top: -0.8006em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_sesstygoto"><span class="mord"><span class="mord mathsf">goto</span></span><span class="mspace nobreak">&nbsp;</span><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_num"><span class="mord mathnormal">n</span></span></span></span></span></span></span><span style="top: 0.6994em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_sesstyend"><span class="mord mathnormal">ε</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 4.3594em;"><span></span></span></span></span></span></span></span></span></span></span></span></div></div><p>In the context of type-level programming, <span class="tex"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.6306em;"></span><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="dual"><span class="mord overline"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6306em;"><span style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_sessty"><span class="mord mathnormal" style="margin-right: 0.03588em;">σ</span></span></span></span></span><span style="top: -3.5506em;"><span class="pstrut" style="height: 3em;"></span><span class="overline-line" style="border-bottom-width: 0.04em;"></span></span></span></span></span></span></span></span></span></span></span></span> is an operator that takes as input a type, and produces a type. Like with <code>MaxLevel</code>, we encode that concept as a trait:</p><div class="listing"><div class="cm-editor ͼ1 ͼ2 ͼo"><div aria-live="polite" style="position: absolute; top: -10000px;"></div><div tabindex="-1" class="cm-scroller"><div class="cm-gutters" aria-hidden="true" style="min-height: 70px; position: sticky;"><div class="cm-gutter cm-lineNumbers"><div class="cm-gutterElement" style="height: 0px; visibility: hidden; pointer-events: none;">9</div><div class="cm-gutterElement" style="height: 14px;">1</div><div class="cm-gutterElement" style="height: 14px;">2</div><div class="cm-gutterElement" style="height: 14px;">3</div><div class="cm-gutterElement" style="height: 14px;">4</div><div class="cm-gutterElement" style="height: 14px;">5</div></div></div><div spellcheck="false" autocorrect="off" autocapitalize="off" translate="no" contenteditable="false" class="cm-content" style="tab-size: 4" role="textbox" aria-multiline="true"><div class="cm-line"><span class="ͼb">trait</span> <span class="ͼi">ComputeDual</span> {</div><div class="cm-line">  <span class="ͼb">type</span> <span class="ͼi">Output</span>;</div><div class="cm-line">}</div><div class="cm-line"><br></div><div class="cm-line"><span class="ͼb">type</span> <span class="ͼi">Dual</span>&lt;<span class="ͼi">S</span>&gt; = &lt;<span class="ͼi">S</span> <span class="ͼb">as</span> <span class="ͼi">ComputeDual</span>&gt;::<span class="ͼi">Output</span>;</div></div></div></div></div><p>Unlike before, <a href="#def-ComputeDual" class="ref"><code>ComputeDual</code></a> only takes one argument <code>Self</code>, so it does not need additional parameters. Like before, we use an alias to simplify later usage of the trait.</p><p>The key idea is that each of the logical rules above cleanly translates into a corresponding trait implementation. First, the base cases:</p><div class="listing"><div class="cm-editor ͼ1 ͼ2 ͼo"><div aria-live="polite" style="position: absolute; top: -10000px;"></div><div tabindex="-1" class="cm-scroller"><div class="cm-gutters" aria-hidden="true" style="min-height: 98px; position: sticky;"><div class="cm-gutter cm-lineNumbers"><div class="cm-gutterElement" style="height: 0px; visibility: hidden; pointer-events: none;">9</div><div class="cm-gutterElement" style="height: 14px;">1</div><div class="cm-gutterElement" style="height: 14px;">2</div><div class="cm-gutterElement" style="height: 14px;">3</div><div class="cm-gutterElement" style="height: 14px;">4</div><div class="cm-gutterElement" style="height: 14px;">5</div><div class="cm-gutterElement" style="height: 14px;">6</div><div class="cm-gutterElement" style="height: 14px;">7</div></div></div><div spellcheck="false" autocorrect="off" autocapitalize="off" translate="no" contenteditable="false" class="cm-content" style="tab-size: 4" role="textbox" aria-multiline="true"><div class="cm-line"><span class="ͼb">impl</span> <span class="ͼi">ComputeDual</span> <span class="ͼb">for</span> <span class="ͼi">Close</span> {</div><div class="cm-line">  <span class="ͼb">type</span> <span class="ͼi">Output</span> = <span class="ͼi">Close</span>;</div><div class="cm-line">}</div><div class="cm-line"><br></div><div class="cm-line"><span class="ͼb">impl</span>&lt;<span class="ͼi">N</span>&gt; <span class="ͼi">ComputeDual</span> <span class="ͼb">for</span> <span class="ͼi">Goto</span>&lt;<span class="ͼi">N</span>&gt; {</div><div class="cm-line">  <span class="ͼb">type</span> <span class="ͼi">Output</span> = <span class="ͼi">Goto</span>&lt;<span class="ͼi">N</span>&gt;;</div><div class="cm-line">}</div></div></div></div></div><p>To represent the inductive cases (e.g. <a href="#def-Send" class="ref"><code>Send</code></a>), we use a <code>where</code> clause to perform an inductive computation. For example:</p><div class="listing"><div class="cm-editor ͼ1 ͼ2 ͼo"><div aria-live="polite" style="position: absolute; top: -10000px;"></div><div tabindex="-1" class="cm-scroller"><div class="cm-gutters" aria-hidden="true" style="min-height: 42px; position: sticky;"><div class="cm-gutter cm-lineNumbers"><div class="cm-gutterElement" style="height: 0px; visibility: hidden; pointer-events: none;">9</div><div class="cm-gutterElement" style="height: 14px;">1</div><div class="cm-gutterElement" style="height: 14px;">2</div><div class="cm-gutterElement" style="height: 14px;">3</div></div></div><div spellcheck="false" autocorrect="off" autocapitalize="off" translate="no" contenteditable="false" class="cm-content" style="tab-size: 4" role="textbox" aria-multiline="true"><div class="cm-line"><span class="ͼb">impl</span>&lt;<span class="ͼi">T</span>, <span class="ͼi">S</span>&gt; <span class="ͼi">ComputeDual</span> <span class="ͼb">for</span> <span class="ͼi">Send</span>&lt;<span class="ͼi">T</span>, <span class="ͼi">S</span>&gt; <span class="ͼb">where</span> <span class="ͼi">S</span>: <span class="ͼi">ComputeDual</span> {</div><div class="cm-line">  <span class="ͼb">type</span> <span class="ͼi">Output</span> = <span class="ͼi">Recv</span>&lt;<span class="ͼi">T</span>, <span class="ͼi">Dual</span>&lt;<span class="ͼi">S</span>&gt;&gt;;</div><div class="cm-line">}</div></div></div></div></div><p>Again, compare this code to the original rule:</p><div class="tex block"><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1.0889em; vertical-align: -0.1944em;"></span><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="dual"><span class="mord overline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8944em;"><span style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_sesstysend"><span class="mord"><span class="mord mathsf">send</span></span><span class="mspace nobreak">&nbsp;</span><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_ty"><span class="mord mathnormal" style="margin-right: 0.1132em;">τ</span></span></span><span class="mpunct">;</span><span class="mspace nobreak">&nbsp;</span><span class="mspace" style="margin-right: 0.1667em;"></span><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_sessty"><span class="mord mathnormal" style="margin-right: 0.03588em;">σ</span></span></span></span></span></span></span><span style="top: -3.8144em;"><span class="pstrut" style="height: 3em;"></span><span class="overline-line" style="border-bottom-width: 0.04em;"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.1944em;"><span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span></span></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.825em; vertical-align: -0.1944em;"></span><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_sesstyrecv"><span class="mord"><span class="mord mathsf" style="margin-right: 0.01389em;">recv</span></span><span class="mspace nobreak">&nbsp;</span><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_ty"><span class="mord mathnormal" style="margin-right: 0.1132em;">τ</span></span></span><span class="mpunct">;</span><span class="mspace nobreak">&nbsp;</span><span class="mspace" style="margin-right: 0.1667em;"></span><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="dual"><span class="mord overline"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6306em;"><span style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span role="link" class="ref hierarchical"><span class="enclosing" data-ref="tex_sessty"><span class="mord mathnormal" style="margin-right: 0.03588em;">σ</span></span></span></span></span><span style="top: -3.5506em;"><span class="pstrut" style="height: 3em;"></span><span class="overline-line" style="border-bottom-width: 0.04em;"></span></span></span></span></span></span></span></span></span></span></span></span></span></span></div><p>Usually, a <code>where</code> bound constrains a trait implementation, e.g. <code>ToString</code> for <code>Vec&lt;T&gt;</code> is only implemented where <code>T: ToString</code>. Here, we re-purpose the bound to perform a computation, i.e. inductively getting the <a href="#def-Dual" class="ref"><code>Dual</code></a> of <code>S</code>.</p><div class="aside block">Note that trait bounds have the form <code>Type: Trait</code>, so we can’t say <code>S: Dual</code> as <code>Dual</code> is a type. We use <code>ComputeDual</code> in the trait bound, then <code>Dual&lt;S&gt;</code> when used as a type.</div><p>As another example, here’s the <a href="#def-Dual" class="ref"><code>Dual</code></a> rule for <a href="#def-Choose" class="ref"><code>Choose</code></a>:</p><div class="listing"><div class="cm-editor ͼ1 ͼ2 ͼo"><div aria-live="polite" style="position: absolute; top: -10000px;"></div><div tabindex="-1" class="cm-scroller"><div class="cm-gutters" aria-hidden="true" style="min-height: 56px; position: sticky;"><div class="cm-gutter cm-lineNumbers"><div class="cm-gutterElement" style="height: 0px; visibility: hidden; pointer-events: none;">9</div><div class="cm-gutterElement" style="height: 14px;">1</div><div class="cm-gutterElement" style="height: 14px;">2</div><div class="cm-gutterElement" style="height: 14px;">3</div><div class="cm-gutterElement" style="height: 14px;">4</div></div></div><div spellcheck="false" autocorrect="off" autocapitalize="off" translate="no" contenteditable="false" class="cm-content" style="tab-size: 4" role="textbox" aria-multiline="true"><div class="cm-line"><span class="ͼb">impl</span>&lt;<span class="ͼi">Left</span>, <span class="ͼi">Right</span>&gt; <span class="ͼi">ComputeDual</span> <span class="ͼb">for</span> <span class="ͼi">Choose</span>&lt;<span class="ͼi">Left</span>, <span class="ͼi">Right</span>&gt;</div><div class="cm-line"><span class="ͼb">where</span> <span class="ͼi">Left</span>: <span class="ͼi">ComputeDual</span>, <span class="ͼi">Right</span>: <span class="ͼi">ComputeDual</span> {</div><div class="cm-line">  <span class="ͼb">type</span> <span class="ͼi">Output</span> = <span class="ͼi">Offer</span>&lt;<span class="ͼi">Dual</span>&lt;<span class="ͼi">Left</span>&gt;, <span class="ͼi">Dual</span>&lt;<span class="ͼi">Right</span>&gt;&gt;;</div><div class="cm-line">}</div></div></div></div></div><p>With these rules in hand, we can now easily specify our client type:</p><div class="listing"><div class="cm-editor ͼ1 ͼ2 ͼo"><div aria-live="polite" style="position: absolute; top: -10000px;"></div><div tabindex="-1" class="cm-scroller"><div class="cm-gutters" aria-hidden="true" style="min-height: 28px; position: sticky;"><div class="cm-gutter cm-lineNumbers"><div class="cm-gutterElement" style="height: 0px; visibility: hidden; pointer-events: none;">9</div><div class="cm-gutterElement" style="height: 14px;">1</div><div class="cm-gutterElement" style="height: 14px;">2</div></div></div><div spellcheck="false" autocorrect="off" autocapitalize="off" translate="no" contenteditable="false" class="cm-content" style="tab-size: 4" role="textbox" aria-multiline="true"><div class="cm-line"><span class="ͼb">type</span> <span class="ͼi">PingServer</span> = <span class="ͼi">Label</span>&lt;<span class="ͼi">Offer</span>&lt;..&gt;&gt;;</div><div class="cm-line"><span class="ͼb">type</span> <span class="ͼi">PingClient</span> = <span class="ͼi">Dual</span>&lt;<span class="ͼi">PingServer</span>&gt;;</div></div></div></div></div><p>That’s it! We’ve successfully encoded dual session types as a type operator in Rust.</p><p>At this point, you may wonder — the translation from the pretty logic to the ugly traits involves a lot of syntax. Take a look at the type-operators crate for using a macro to automatically perform the translation.</p></section><section><h2 class="section-title"><div id="def-section-2.2" class="definition"><span class="section-number">2.2</span>  Label and Goto</div></h2><p>Our final challenge is to implement the <code>label</code> and <code>goto</code> operators. We start with the following skeleton, needing to fill in the <code>?</code>:</p><div class="listing"><div class="cm-editor ͼ1 ͼ2 ͼo"><div aria-live="polite" style="position: absolute; top: -10000px;"></div><div tabindex="-1" class="cm-scroller"><div class="cm-gutters" aria-hidden="true" style="min-height: 182px; position: sticky;"><div class="cm-gutter cm-lineNumbers"><div class="cm-gutterElement" style="height: 0px; visibility: hidden; pointer-events: none;">99</div><div class="cm-gutterElement" style="height: 14px;">1</div><div class="cm-gutterElement" style="height: 14px;">2</div><div class="cm-gutterElement" style="height: 14px;">3</div><div class="cm-gutterElement" style="height: 14px;">4</div><div class="cm-gutterElement" style="height: 14px;">5</div><div class="cm-gutterElement" style="height: 14px;">6</div><div class="cm-gutterElement" style="height: 14px;">7</div><div class="cm-gutterElement" style="height: 14px;">8</div><div class="cm-gutterElement" style="height: 14px;">9</div><div class="cm-gutterElement" style="height: 14px;">10</div><div class="cm-gutterElement" style="height: 14px;">11</div><div class="cm-gutterElement" style="height: 14px;">12</div><div class="cm-gutterElement" style="height: 14px;">13</div></div></div><div spellcheck="false" autocorrect="off" autocapitalize="off" translate="no" contenteditable="false" class="cm-content" style="tab-size: 4" role="textbox" aria-multiline="true"><div class="cm-line"><span class="ͼb">impl</span>&lt;<span class="ͼi">Env</span>, <span class="ͼi">S</span>&gt; <span class="ͼi">Chan</span>&lt;<span class="ͼi">Env</span>, <span class="ͼi">Label</span>&lt;<span class="ͼi">S</span>&gt;&gt; {</div><div class="cm-line">  <span class="ͼm">// should push S onto Env</span></div><div class="cm-line">  <span class="ͼb">pub</span> <span class="ͼb">fn</span> <span class="ͼg">label</span>(<span class="ͼb">self</span>) -&gt; <span class="ͼi">Chan</span>&lt;?, <span class="ͼi">S</span>&gt; {</div><div class="cm-line">    <span class="ͼb">unsafe</span> { transmute(<span class="ͼb">self</span>) }</div><div class="cm-line">  }</div><div class="cm-line">}</div><div class="cm-line"><br></div><div class="cm-line"><span class="ͼb">impl</span>&lt;<span class="ͼi">Env</span>, <span class="ͼi">N</span>&gt; <span class="ͼi">Chan</span>&lt;<span class="ͼi">Env</span>, <span class="ͼi">Goto</span>&lt;<span class="ͼi">N</span>&gt;&gt; {</div><div class="cm-line">  <span class="ͼm">// should get the Nth type in Env and drop the first N items from Env</span></div><div class="cm-line">  <span class="ͼb">pub</span> <span class="ͼb">fn</span> <span class="ͼg">goto</span>(<span class="ͼb">self</span>) -&gt; <span class="ͼi">Chan</span>&lt;?, ?&gt; {</div><div class="cm-line">    <span class="ͼb">unsafe</span> { transmute(<span class="ͼb">self</span>) }</div><div class="cm-line">  }</div><div class="cm-line">}</div></div></div></div></div><p>We are going to encode <code>Env</code> as a <em>list of session types</em>. To do so, we need to resolve four questions:</p><ol><li><p>How do we represent a list of types?</p></li><li><p>How do we push to a list of types?</p></li><li><p>How do we get the <span class="tex"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span></span>-th type in a list of types?</p></li><li><p>How do we drop the first <span class="tex"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span></span> types in a list of types?</p></li></ol><p>Like in a functional programming language, we will use a linked-list nil/cons style to represent a type list.</p><div class="listing"><div class="cm-editor ͼ1 ͼ2 ͼo"><div aria-live="polite" style="position: absolute; top: -10000px;"></div><div tabindex="-1" class="cm-scroller"><div class="cm-gutters" aria-hidden="true" style="min-height: 70px; position: sticky;"><div class="cm-gutter cm-lineNumbers"><div class="cm-gutterElement" style="height: 0px; visibility: hidden; pointer-events: none;">9</div><div class="cm-gutterElement" style="height: 14px;">1</div><div class="cm-gutterElement" style="height: 14px;">2</div><div class="cm-gutterElement" style="height: 14px;">3</div><div class="cm-gutterElement" style="height: 14px;">4</div><div class="cm-gutterElement" style="height: 14px;">5</div></div></div><div spellcheck="false" autocorrect="off" autocapitalize="off" translate="no" contenteditable="false" class="cm-content" style="tab-size: 4" role="textbox" aria-multiline="true"><div class="cm-line"><span class="ͼb">type</span> <span class="ͼi">EmptyList</span> = ();      <span class="ͼm">// or "Nil"  if you prefer</span></div><div class="cm-line"><span class="ͼb">type</span> <span class="ͼi">Push</span>&lt;<span class="ͼi">L</span>, <span class="ͼi">T</span>&gt; = (<span class="ͼi">T</span>, <span class="ͼi">L</span>); <span class="ͼm">// or "Cons" if you prefer</span></div><div class="cm-line"><br></div><div class="cm-line"><span class="ͼb">type</span> <span class="ͼi">ExampleList</span> = <span class="ͼi">Push</span>&lt;<span class="ͼi">Push</span>&lt;<span class="ͼi">EmptyList</span>, <span class="ͼi">String</span>&gt;, <span class="ͼi">bool</span>&gt;;</div><div class="cm-line"><span class="ͼm">// ExampleList = (bool, (String, ()))</span></div></div></div></div></div><p>Then to get the <span class="tex"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span></span>-th type in a list, we can use a type-level operator encoded as a trait, using a familiar pattern:</p><div class="listing"><div class="cm-editor ͼ1 ͼ2 ͼo"><div aria-live="polite" style="position: absolute; top: -10000px;"></div><div tabindex="-1" class="cm-scroller"><div class="cm-gutters" aria-hidden="true" style="min-height: 28px; position: sticky;"><div class="cm-gutter cm-lineNumbers"><div class="cm-gutterElement" style="height: 0px; visibility: hidden; pointer-events: none;">9</div><div class="cm-gutterElement" style="height: 14px;">1</div><div class="cm-gutterElement" style="height: 14px;">2</div></div></div><div spellcheck="false" autocorrect="off" autocapitalize="off" translate="no" contenteditable="false" class="cm-content" style="tab-size: 4" role="textbox" aria-multiline="true"><div class="cm-line"><span class="ͼb">trait</span> <span class="ͼi">ComputeNth</span>&lt;<span class="ͼi">N</span>&gt; { <span class="ͼb">type</span> <span class="ͼi">Output</span>; }</div><div class="cm-line"><span class="ͼb">type</span> <span class="ͼi">Nth</span>&lt;<span class="ͼi">L</span>, <span class="ͼi">N</span>&gt; = &lt;<span class="ͼi">L</span> <span class="ͼb">as</span> <span class="ͼi">ComputeNth</span>&lt;<span class="ͼi">N</span>&gt;&gt;::<span class="ͼi">Output</span>;</div></div></div></div></div><p>Think for a moment about the inductive definition of <code>Nth</code> as you might write it in OCaml or Haskell. It probably looks something like this:</p><div class="tex block"><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 3em; vertical-align: -1.25em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.75em;"><span style="top: -3.91em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathsf">nth</span></span><span class="mspace nobreak">&nbsp;</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.1132em;">τ</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">ℓ</span><span class="mclose">)</span><span class="mspace nobreak">&nbsp;</span><span class="mord">0</span></span></span><span style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathsf">nth</span></span><span class="mspace nobreak">&nbsp;</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.1132em;">τ</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">ℓ</span><span class="mclose">)</span><span class="mspace nobreak">&nbsp;</span><span class="mord mathnormal">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.25em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.75em;"><span style="top: -3.91em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mord mathnormal" style="margin-right: 0.1132em;">τ</span></span></span><span style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mord"><span class="mord mathsf">nth</span></span><span class="mspace nobreak">&nbsp;</span><span class="mord">ℓ</span><span class="mspace nobreak">&nbsp;</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.25em;"><span></span></span></span></span></span></span></span></span></span></span></span></div><p>Just like with dual session types, we can straightforwardly encode these logical rules into trait implementations. However, because we are using a Peano encoding of the natural numbers, we’ll tweak the second rule to look like this:</p><div class="tex block"><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathsf">nth</span></span><span class="mspace nobreak">&nbsp;</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.1132em;">τ</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">ℓ</span><span class="mclose">)</span><span class="mspace nobreak">&nbsp;</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6944em;"></span><span class="mord"><span class="mord mathsf">nth</span></span><span class="mspace nobreak">&nbsp;</span><span class="mord">ℓ</span><span class="mspace nobreak">&nbsp;</span><span class="mord mathnormal">n</span></span></span></span></span></div><p>Then the encoding of <code>Nth</code> into Rust traits becomes 1-to-1:</p><div class="listing"><div class="cm-editor ͼ1 ͼ2 ͼo"><div aria-live="polite" style="position: absolute; top: -10000px;"></div><div tabindex="-1" class="cm-scroller"><div class="cm-gutters" aria-hidden="true" style="min-height: 98px; position: sticky;"><div class="cm-gutter cm-lineNumbers"><div class="cm-gutterElement" style="height: 0px; visibility: hidden; pointer-events: none;">9</div><div class="cm-gutterElement" style="height: 14px;">1</div><div class="cm-gutterElement" style="height: 14px;">2</div><div class="cm-gutterElement" style="height: 14px;">3</div><div class="cm-gutterElement" style="height: 14px;">4</div><div class="cm-gutterElement" style="height: 14px;">5</div><div class="cm-gutterElement" style="height: 14px;">6</div><div class="cm-gutterElement" style="height: 14px;">7</div></div></div><div spellcheck="false" autocorrect="off" autocapitalize="off" translate="no" contenteditable="false" class="cm-content" style="tab-size: 4" role="textbox" aria-multiline="true"><div class="cm-line"><span class="ͼb">impl</span>&lt;<span class="ͼi">T</span>, <span class="ͼi">L</span>&gt; <span class="ͼi">ComputeNth</span>&lt;<span class="ͼi">Z</span>&gt; <span class="ͼb">for</span> <span class="ͼi">Push</span>&lt;<span class="ͼi">T</span>, <span class="ͼi">L</span>&gt; {</div><div class="cm-line">  <span class="ͼb">type</span> <span class="ͼi">Output</span> = <span class="ͼi">T</span>;</div><div class="cm-line">}</div><div class="cm-line"><br></div><div class="cm-line"><span class="ͼb">impl</span>&lt;<span class="ͼi">T</span>, <span class="ͼi">L</span>, <span class="ͼi">N</span>&gt; <span class="ͼi">ComputeNth</span>&lt;<span class="ͼi">S</span>&lt;<span class="ͼi">N</span>&gt;&gt; <span class="ͼb">for</span> <span class="ͼi">Push</span>&lt;<span class="ͼi">T</span>, <span class="ͼi">L</span>&gt; <span class="ͼb">where</span> <span class="ͼi">L</span>: <span class="ͼi">ComputeNth</span>&lt;<span class="ͼi">N</span>&gt; {</div><div class="cm-line">  <span class="ͼb">type</span> <span class="ͼi">Output</span> = <span class="ͼi">Nth</span>&lt;<span class="ͼi">L</span>, <span class="ͼi">N</span>&gt;;</div><div class="cm-line">}</div></div></div></div></div><p>Similarly, we can create a function that drops the first <code>N</code> elements from a type list:</p><div class="listing"><div class="cm-editor ͼ1 ͼ2 ͼo"><div aria-live="polite" style="position: absolute; top: -10000px;"></div><div tabindex="-1" class="cm-scroller"><div class="cm-gutters" aria-hidden="true" style="min-height: 154px; position: sticky;"><div class="cm-gutter cm-lineNumbers"><div class="cm-gutterElement" style="height: 0px; visibility: hidden; pointer-events: none;">99</div><div class="cm-gutterElement" style="height: 14px;">1</div><div class="cm-gutterElement" style="height: 14px;">2</div><div class="cm-gutterElement" style="height: 14px;">3</div><div class="cm-gutterElement" style="height: 14px;">4</div><div class="cm-gutterElement" style="height: 14px;">5</div><div class="cm-gutterElement" style="height: 14px;">6</div><div class="cm-gutterElement" style="height: 14px;">7</div><div class="cm-gutterElement" style="height: 14px;">8</div><div class="cm-gutterElement" style="height: 14px;">9</div><div class="cm-gutterElement" style="height: 14px;">10</div><div class="cm-gutterElement" style="height: 14px;">11</div></div></div><div spellcheck="false" autocorrect="off" autocapitalize="off" translate="no" contenteditable="false" class="cm-content" style="tab-size: 4" role="textbox" aria-multiline="true"><div class="cm-line"><span class="ͼb">trait</span> <span class="ͼi">ComputeDropFirst</span>&lt;<span class="ͼi">N</span>&gt; { <span class="ͼb">type</span> <span class="ͼi">Output</span>; }</div><div class="cm-line"><span class="ͼb">type</span> <span class="ͼi">DropFirst</span>&lt;<span class="ͼi">L</span>, <span class="ͼi">N</span>&gt; = &lt;<span class="ͼi">L</span> <span class="ͼb">as</span> <span class="ͼi">ComputeDropFirst</span>&lt;<span class="ͼi">N</span>&gt;&gt;::<span class="ͼi">Output</span>;</div><div class="cm-line"><br></div><div class="cm-line"><span class="ͼb">impl</span>&lt;<span class="ͼi">L</span>&gt; <span class="ͼi">ComputeDropFirst</span>&lt;<span class="ͼi">Z</span>&gt; <span class="ͼb">for</span> <span class="ͼi">L</span> {</div><div class="cm-line">  <span class="ͼb">type</span> <span class="ͼi">Output</span> = <span class="ͼi">L</span>;</div><div class="cm-line">}</div><div class="cm-line"><br></div><div class="cm-line"><span class="ͼb">impl</span>&lt;<span class="ͼi">T</span>, <span class="ͼi">L</span>, <span class="ͼi">N</span>&gt; <span class="ͼi">ComputeDropFirst</span>&lt;<span class="ͼi">S</span>&lt;<span class="ͼi">N</span>&gt;&gt; <span class="ͼb">for</span> <span class="ͼi">Push</span>&lt;<span class="ͼi">T</span>, <span class="ͼi">L</span>&gt;</div><div class="cm-line"><span class="ͼb">where</span> <span class="ͼi">L</span>: <span class="ͼi">ComputeDropFirst</span>&lt;<span class="ͼi">N</span>&gt; {</div><div class="cm-line">  <span class="ͼb">type</span> <span class="ͼi">Output</span> = <span class="ͼi">DropFirst</span>&lt;<span class="ͼi">L</span>, <span class="ͼi">N</span>&gt;;</div><div class="cm-line">}</div></div></div></div></div><p>With these type-level operators in hand, we can finish our label and goto implementations. Now, <code>label</code> is a simple <code>Push</code>:</p><div class="listing"><div class="cm-editor ͼ1 ͼ2 ͼo"><div aria-live="polite" style="position: absolute; top: -10000px;"></div><div tabindex="-1" class="cm-scroller"><div class="cm-gutters" aria-hidden="true" style="min-height: 70px; position: sticky;"><div class="cm-gutter cm-lineNumbers"><div class="cm-gutterElement" style="height: 0px; visibility: hidden; pointer-events: none;">9</div><div class="cm-gutterElement" style="height: 14px;">1</div><div class="cm-gutterElement" style="height: 14px;">2</div><div class="cm-gutterElement" style="height: 14px;">3</div><div class="cm-gutterElement" style="height: 14px;">4</div><div class="cm-gutterElement" style="height: 14px;">5</div></div></div><div spellcheck="false" autocorrect="off" autocapitalize="off" translate="no" contenteditable="false" class="cm-content" style="tab-size: 4" role="textbox" aria-multiline="true"><div class="cm-line"><span class="ͼb">impl</span>&lt;<span class="ͼi">Env</span>, <span class="ͼi">S</span>&gt; <span class="ͼi">Chan</span>&lt;<span class="ͼi">Env</span>, <span class="ͼi">Label</span>&lt;<span class="ͼi">S</span>&gt;&gt; {</div><div class="cm-line">  <span class="ͼb">pub</span> <span class="ͼb">fn</span> <span class="ͼg">label</span>(<span class="ͼb">self</span>) -&gt; <span class="ͼi">Chan</span>&lt;<span class="ͼi">Push</span>&lt;<span class="ͼi">S</span>, <span class="ͼi">Env</span>&gt;, <span class="ͼi">S</span>&gt; {</div><div class="cm-line">    <span class="ͼb">unsafe</span> { transmute(<span class="ͼb">self</span>) }</div><div class="cm-line">  }</div><div class="cm-line">}</div></div></div></div></div><p>The <code>goto</code> function is more complex. We need to both get the <code>Nth</code> element of an environment, and drop the first <code>N</code> elements.</p><div class="listing"><div class="cm-editor ͼ1 ͼ2 ͼo"><div aria-live="polite" style="position: absolute; top: -10000px;"></div><div tabindex="-1" class="cm-scroller"><div class="cm-gutters" aria-hidden="true" style="min-height: 84px; position: sticky;"><div class="cm-gutter cm-lineNumbers"><div class="cm-gutterElement" style="height: 0px; visibility: hidden; pointer-events: none;">9</div><div class="cm-gutterElement" style="height: 14px;">1</div><div class="cm-gutterElement" style="height: 14px;">2</div><div class="cm-gutterElement" style="height: 14px;">3</div><div class="cm-gutterElement" style="height: 14px;">4</div><div class="cm-gutterElement" style="height: 14px;">5</div><div class="cm-gutterElement" style="height: 14px;">6</div></div></div><div spellcheck="false" autocorrect="off" autocapitalize="off" translate="no" contenteditable="false" class="cm-content" style="tab-size: 4" role="textbox" aria-multiline="true"><div class="cm-line"><span class="ͼb">impl</span>&lt;<span class="ͼi">Env</span>, <span class="ͼi">N</span>&gt; <span class="ͼi">Chan</span>&lt;<span class="ͼi">Env</span>, <span class="ͼi">Goto</span>&lt;<span class="ͼi">N</span>&gt;&gt;</div><div class="cm-line"><span class="ͼb">where</span> <span class="ͼi">Env</span>: <span class="ͼi">ComputeNth</span>&lt;<span class="ͼi">N</span>&gt; + <span class="ͼi">ComputeDropFirst</span>&lt;<span class="ͼi">N</span>&gt; {</div><div class="cm-line">  <span class="ͼb">pub</span> <span class="ͼb">fn</span> <span class="ͼg">goto</span>(<span class="ͼb">self</span>) -&gt; <span class="ͼi">Chan</span>&lt;<span class="ͼi">DropFirst</span>&lt;<span class="ͼi">Env</span>, <span class="ͼi">N</span>&gt;, <span class="ͼi">Nth</span>&lt;<span class="ͼi">Env</span>, <span class="ͼi">N</span>&gt;&gt; {</div><div class="cm-line">    <span class="ͼb">unsafe</span> { transmute(<span class="ͼb">self</span>) }</div><div class="cm-line">  }</div><div class="cm-line">}</div></div></div></div></div><p>Note that because we use <code>Env</code> with two type-level operators, we have to add both as bounds combined with <code>+</code>.</p></section></section><section><h1 class="section-title"><div id="def-section-3" class="definition"><span class="section-number">3</span>  Traits as Relations</div></h1><p>The relationship between types, traits, and logic programming has been an enduring theme in the Rust community. <a href="http://smallcultfollowing.com/babysteps/blog/2017/01/26/lowering-rust-traits-to-logic/">"Lowering Rust traits to logic"</a> and the ongoing efforts on <a href="https://github.com/rust-lang/chalk">chalk</a> both show how resolving trait bounds is equivalent to executing a logic program.</p><p>In this note, I tried to go in the opposite direction — showing how domain-specific type-systems, whose rules are often written as logical relations, can be lowered into Rust traits. I think this is valuable because:</p><ul><li><p>Domain-specific type systems enable powerful compile-time checks on complex properties. Checking that communication protocols are followed, or that secure information is protected, usually requires external model checkers. Here, we just need Rust!</p></li><li><p>Encoding logic rules into Rust traits in a practical way is not obvious at first glance. There aren’t many examples of this pattern to generalize from.</p></li></ul><p>For example, if we took our type operators above, we could concisely encode their logic as a logic program (using Prolog-esque syntax):</p><div class="listing"><div class="cm-editor ͼ1 ͼ2 ͼo"><div aria-live="polite" style="position: absolute; top: -10000px;"></div><div tabindex="-1" class="cm-scroller"><div class="cm-gutters" aria-hidden="true" style="min-height: 182px; position: sticky;"><div class="cm-gutter cm-lineNumbers"><div class="cm-gutterElement" style="height: 0px; visibility: hidden; pointer-events: none;">99</div><div class="cm-gutterElement" style="height: 14px;">1</div><div class="cm-gutterElement" style="height: 14px;">2</div><div class="cm-gutterElement" style="height: 14px;">3</div><div class="cm-gutterElement" style="height: 14px;">4</div><div class="cm-gutterElement" style="height: 14px;">5</div><div class="cm-gutterElement" style="height: 14px;">6</div><div class="cm-gutterElement" style="height: 14px;">7</div><div class="cm-gutterElement" style="height: 14px;">8</div><div class="cm-gutterElement" style="height: 14px;">9</div><div class="cm-gutterElement" style="height: 14px;">10</div><div class="cm-gutterElement" style="height: 14px;">11</div><div class="cm-gutterElement" style="height: 14px;">12</div><div class="cm-gutterElement" style="height: 14px;">13</div></div></div><div spellcheck="false" autocorrect="off" autocapitalize="off" translate="no" contenteditable="false" class="cm-content" style="tab-size: 4" role="textbox" aria-multiline="true"><div class="cm-line">% MaxLevel(Self, Other, Output)</div><div class="cm-line">MaxLevel(Low, Low, Low).</div><div class="cm-line">MaxLevel(Low, High, High).</div><div class="cm-line">MaxLevel(High, Low, High).</div><div class="cm-line">MaxLevel(High, High, High).</div><div class="cm-line"><br></div><div class="cm-line">% Dual(Self, Output)</div><div class="cm-line">Dual(Close, Close).</div><div class="cm-line">Dual(Recv&lt;T, S&gt;, Send&lt;T, S2&gt;) :- Dual(S, S2).</div><div class="cm-line"><br></div><div class="cm-line">% Nth(Self, N, Output)</div><div class="cm-line">Nth(X :: L, 0, X).</div><div class="cm-line">Nth(X :: L, I+1, X2) :- Nth(L, I, X2).</div></div></div></div></div><p>Seeing this pattern, we can construct a general translation. A type operator is a relation with <code>Self</code> as the first argument, <code>Output</code> as the last argument, and additional arguments in between. So a general relation <code>Rel(Self, Arg1, .., ArgN, Output)</code> translates to:</p><div class="listing"><div class="cm-editor ͼ1 ͼ2 ͼo"><div aria-live="polite" style="position: absolute; top: -10000px;"></div><div tabindex="-1" class="cm-scroller"><div class="cm-gutters" aria-hidden="true" style="min-height: 28px; position: sticky;"><div class="cm-gutter cm-lineNumbers"><div class="cm-gutterElement" style="height: 0px; visibility: hidden; pointer-events: none;">9</div><div class="cm-gutterElement" style="height: 14px;">1</div><div class="cm-gutterElement" style="height: 14px;">2</div></div></div><div spellcheck="false" autocorrect="off" autocapitalize="off" translate="no" contenteditable="false" class="cm-content" style="tab-size: 4" role="textbox" aria-multiline="true"><div class="cm-line"><span class="ͼb">trait</span> <span class="ͼi">ComputeRel</span>&lt;<span class="ͼi">Arg1</span>, ..., <span class="ͼi">ArgN</span>&gt; { <span class="ͼb">type</span> <span class="ͼi">Output</span>; }</div><div class="cm-line"><span class="ͼb">type</span> <span class="ͼi">Rel</span>&lt;<span class="ͼi">Self</span>, <span class="ͼi">Arg1</span>, ..., <span class="ͼi">ArgN</span>&gt; = &lt;<span class="ͼi">Self</span> <span class="ͼb">as</span> <span class="ͼi">Rel</span>&lt;<span class="ͼi">Arg1</span>, ..., <span class="ͼi">ArgN</span>&gt;&gt;::<span class="ͼi">Output</span>;</div></div></div></div></div><p>An unconditional fact like <code>Rel(Tself, T1, ... TN, Tout)</code> becomes an <code>impl</code> block without a <code>where</code> clause:</p><div class="listing"><div class="cm-editor ͼ1 ͼ2 ͼo"><div aria-live="polite" style="position: absolute; top: -10000px;"></div><div tabindex="-1" class="cm-scroller"><div class="cm-gutters" aria-hidden="true" style="min-height: 14px; position: sticky;"><div class="cm-gutter cm-lineNumbers"><div class="cm-gutterElement" style="height: 0px; visibility: hidden; pointer-events: none;">9</div><div class="cm-gutterElement" style="height: 14px;">1</div></div></div><div spellcheck="false" autocorrect="off" autocapitalize="off" translate="no" contenteditable="false" class="cm-content" style="tab-size: 4" role="textbox" aria-multiline="true"><div class="cm-line"><span class="ͼb">impl</span> <span class="ͼi">ComputeRel</span>&lt;<span class="ͼi">T1</span>, ..., <span class="ͼi">TN</span>&gt; <span class="ͼb">for</span> <span class="ͼi">Tself</span> { <span class="ͼb">type</span> <span class="ͼi">Output</span> = <span class="ͼi">Tout</span>; }</div></div></div></div></div><p>And a complex conditional fact like:</p><div class="listing"><div class="cm-editor ͼ1 ͼ2 ͼo"><div aria-live="polite" style="position: absolute; top: -10000px;"></div><div tabindex="-1" class="cm-scroller"><div class="cm-gutters" aria-hidden="true" style="min-height: 28px; position: sticky;"><div class="cm-gutter cm-lineNumbers"><div class="cm-gutterElement" style="height: 0px; visibility: hidden; pointer-events: none;">9</div><div class="cm-gutterElement" style="height: 14px;">1</div><div class="cm-gutterElement" style="height: 14px;">2</div></div></div><div spellcheck="false" autocorrect="off" autocapitalize="off" translate="no" contenteditable="false" class="cm-content" style="tab-size: 4" role="textbox" aria-multiline="true"><div class="cm-line">Rel(Tself, T1, ..., TN, Tout) :-</div><div class="cm-line">  OtherRel(Tself, Totherout), Rel(Totherout, T1, ..., TN, Tout).</div></div></div></div></div><p>Becomes an <code>impl</code> block with a <code>where</code> clause:</p><div class="listing"><div class="cm-editor ͼ1 ͼ2 ͼo"><div aria-live="polite" style="position: absolute; top: -10000px;"></div><div tabindex="-1" class="cm-scroller"><div class="cm-gutters" aria-hidden="true" style="min-height: 56px; position: sticky;"><div class="cm-gutter cm-lineNumbers"><div class="cm-gutterElement" style="height: 0px; visibility: hidden; pointer-events: none;">9</div><div class="cm-gutterElement" style="height: 14px;">1</div><div class="cm-gutterElement" style="height: 14px;">2</div><div class="cm-gutterElement" style="height: 14px;">3</div><div class="cm-gutterElement" style="height: 14px;">4</div></div></div><div spellcheck="false" autocorrect="off" autocapitalize="off" translate="no" contenteditable="false" class="cm-content" style="tab-size: 4" role="textbox" aria-multiline="true"><div class="cm-line"><span class="ͼb">impl</span> <span class="ͼi">ComputeRel</span>&lt;<span class="ͼi">T1</span>, ..., <span class="ͼi">TN</span>&gt; <span class="ͼb">for</span> <span class="ͼi">Tself</span></div><div class="cm-line"><span class="ͼb">where</span> <span class="ͼi">Tself</span>: <span class="ͼi">ComputeOtherRel</span>, <span class="ͼi">OtherRel</span>&lt;<span class="ͼi">Tself</span>&gt;: <span class="ͼi">ComputeRel</span>&lt;<span class="ͼi">T1</span>, ..., <span class="ͼi">TN</span>&gt; {</div><div class="cm-line">  <span class="ͼb">type</span> <span class="ͼi">Output</span> = <span class="ͼi">Rel</span>&lt;<span class="ͼi">OtherRel</span>&lt;<span class="ͼi">Tself</span>&gt;&gt;;</div><div class="cm-line">}</div></div></div></div></div><p>In drawing this connection between traits and logic programs, I hope that you might find it easier to encode new domain-specific type systems in Rust. These examples also demonstrate that there’s a lot of exciting future work in developing libraries and best practices for type-level programming!</p></section><div class="logger"></div><div class="portal"></div></div></div><script src="./index.mjs" type="module" async=""></script></body></html>